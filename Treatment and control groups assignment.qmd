---
title: "Treatment and control groups assignments"
author: "Iriana Razafimahenina"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

## Treatment and control groups assignment

-   [Groupe de traitement]{.underline}: ménage vivant dans ou à moins de 10 km des aires protégées entre 2008 et 2021

-   [Groupe de contrôle]{.underline}: ménage vivant à plus de 10 km des aires protégées entre 2008 et 2021

```{r}
# Chargement des librairies
library(tidyverse)
library(sf)
library(haven)
library(tmap)

my_crs <- 29702
buffer_dist <- 10000

# Load boundary
contour_mada <- gadm(country = "Madagascar", level = 0, path = "Data") %>%
    st_as_sf() %>%
    st_transform(29702)
  
# Load DHS data 
dhs_folder <- "C:/Users/irian/Documents/IRD_Drive/BETSAKA_MADAGASCAR/Données/Enquêtes ménages/DHS Madagascar/DHS_data"

load_data <- function(year, type, dhs_folder) {
  year_folder <- file.path(dhs_folder, paste0("DHS_", year))
  
  # Get the .shp (GPS) and .dta (household) file paths
  if (type == "HR") {
    hr_path <- list.files(year_folder, pattern = ".*HR.*\\.dta$", 
                          full.names = TRUE, recursive = TRUE, ignore.case = TRUE)
    if (length(hr_path) == 0) stop("No HR file found for the specified year.")
    out <- read_dta(hr_path) # Lecture du fichier .dta
  } else if (type == "GPS") {
    shp_path <- list.files(year_folder, pattern = "\\.shp$", full.names = TRUE, recursive = TRUE)
    if (length(shp_path) == 0) stop("No GPS file found for the specified year.")
    out <- st_read(shp_path, quiet = TRUE) %>%
      st_transform(29702) # Lecture du fichier .shp
  } else {
    stop("Data type unknown, must be HR or GPS")
  }
  return(out) 
}
  
# Execute the function for a specific year
hr_2008 <- load_data(2008, "HR", dhs_folder)
gps_2008 <- load_data(2008, "GPS", dhs_folder)
  
hr_2021 <- load_data(2021, "HR", dhs_folder)
gps_2021 <- load_data(2021, "GPS", dhs_folder)
# TODO : charger données 1997
  
# Vérification des données GPS
# print(gps_2008)
# print(gps_2021)
#   
# st_geometry(gps_2008)
# st_geometry(gps_2021)

# Vérification des données GPS
  if (!"DHSCLUST" %in% colnames(gps_2008)) {
    stop("La colonne 'DHSCLUST' n'existe pas dans les données GPS.")
  } else {
    message("Les clusters sont bien identifiés.")
  }
  
  if (!"DHSCLUST" %in% colnames(gps_2021)) {
    stop("La colonne 'DHSCLUST' n'existe pas dans les données GPS.")
  } else {
    message("Les clusters sont bien identifiés.")
  }


# Message de confirmation
cat("Les fichiers household_cluster_2008.rds et household_cluster_2021.rds ont été sauvegardés avec succès.\n")

# Visualiser les buffers et les points GPS 
tmap_mode("view")

contour_mada %>% 
  st_transform(my_crs) %>% 
  tm_shape() +
    tm_borders(col = "black")


# Load SAPM data
 sapm <- st_read("C:/Users/irian/Documents/IRD_Drive/BETSAKA_MADAGASCAR/Données/Aires protégées/SAPM_2017_corrected/SAPM_2017_corrected.shp", quiet = TRUE) %>%
 st_transform(my_crs) %>%
  st_make_valid()

# Intersection des SAPM avec la limite de Madagascar
sapm_land <- sapm %>% 
  st_intersection(contour_mada)%>%
  st_make_valid()

# Specifier les aires protégées avant 2008 et après 2008
sapm_land_post2008 <- sapm_land %>%
  filter(year(DATE_CREAT) >= 2008)

sapm_land_pre2008 <- sapm_land %>%
  filter(year(DATE_CREAT) < 2008)

# Créer des buffers de 10 km autour des AP
sapm_land_post2008_buffer <- sapm_land_post2008  %>%
  st_buffer(dist = buffer_dist) %>% 
  st_make_valid() %>%
  st_union() %>%
  st_as_sf() %>%
  st_make_valid()

sapm_land_pre2008_buffer <- sapm_land_pre2008 %>%
  st_buffer(dist = buffer_dist) %>%
  st_make_valid() %>%
  st_union() %>%
  st_as_sf() %>%
  st_make_valid()

tm_shape(sapm_land_post2008_buffer) +
  tm_borders(col = "blue") +
  tm_shape(sapm_land_pre2008_buffer) +
  tm_borders(col = "red") +
  tm_shape(sapm_land_post2008) +
  tm_polygons(fill = "blue") +
  tm_shape(sapm_land_pre2008) +
  tm_polygons(fill = "red")

# identifier le groupe de traitement: ménages proche d'AP créés après 2008
 
gps_cluster_2008 <- gps_2008 %>%
  mutate(proche_AP_pre2008 = st_within(geometry, sapm_land_pre2008_buffer, sparse = FALSE)[, 1],
         proche_AP_post2008 = st_within(geometry, sapm_land_post2008_buffer, sparse = FALSE)[, 1],
         groupe = case_when(
           proche_AP_post2008 & !(proche_AP_pre2008) & URBAN_RURA == "R" ~ "Traitement",
           proche_AP_pre2008 | URBAN_RURA == "U" ~ "Exclu",
           !(proche_AP_post2008) & !(proche_AP_pre2008) & URBAN_RURA == "R" ~ "Controle"))
 

# Insérer un tableau qui compte les clusters en fonction de leur groupe.

table(gps_cluster_2008$groupe, useNA = "always")

# identifier le groupe de controle: ménages à plus de 10 km 


# Exclure les clusters à moins de 10 km d'une AP créés avant 2008 

# Créer un plot pour visualiser la carte des AP avec les clusters


```

Trois cas de figure :

1.  cluster à moins de 10km d'une AP créée avant 2008 : groupe à exclure

2.  cluster à moins de 10km d'une AP créée après 2008 : groupe de traitement

3.  cluster à plus de 10km d'une AP : groupe de controle
