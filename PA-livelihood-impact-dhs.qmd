---
title: "PA-livelihood-impact-dhs"
author: "Iriana Razafimahenina"
format: 
  html:
   out-put-file: index.html
   embed-resources: true
   standalone: true
   code-fold: true
  execute:
   warning: false
   error: false
editor: visual
editor-options: 
   chunk_out_type: console
Bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

# Environnement

```{r}
library(tidyverse) #Manipulation et visualisation des données
library(haven) #Importation des données
library(writexl) #Exportation des données
library(sf) #Analyse des données spatiales
library(tmap) #Analyse cartographique
library(codebook) #Documentation et mise en forme des données 
library(gt) #Mise en forme des tableaux 
library(survey) #Analyse des données d'enquêtes
library(MatchIt) #Matching
library(ggplot2) #Figure
library(labelled) # Manipulation des labels
library(readxl) #Lecture des fichiers excels
library(progressr) # Pour avoir des barres de progression
library(tictoc) # Pour minuter le temps d'exécution
library(mapme.biodiversity)
library(future) # Pour permettre du calcul parallèle
library(lubridate) # Gestion des dates
library(terra) # Manipulation des données raster 
library(geodata)
```

# Data structuring

Nous allons chargé les données nécessaires à l'analyse.

## Socioeconomic household data

### Reproduction of wealth index

## Data on the household geophysical environment

Nous allons utiliser le package R mapme.biodiversity (<https://mapme-initiative.github.io/mapme.biodiversity/index.html>) pour charger et extraire les données sur la couverture forestière, la pente et l'altitude, la densité de population, l'accessibilité en 2000.

```{r}
# Définir le chemin absolu pour ton répertoire local
outdir <- "Statistiques/PA-livelihood-impact-dhs2/Data"

# Créer le répertoire si il n'existe pas déjà
dir.create(outdir, recursive = TRUE, showWarnings = FALSE)

# Vérifier si le répertoire a bien été créé
if (dir.exists(outdir)) {
  cat("Répertoire créé ou déjà existant : ", outdir)
} else {
  cat("Le répertoire n'a pas pu être créé.")
}
mapme_options(
  outdir = outdir,
  verbose = TRUE
              )
```

### Définition des unités d'analyse

L'unité d'analyse de cette études est le ménage. Nous allons charger nos clusters de 2008 et 2021.

```{r clusters}

# Définition du système de coordonnées et de la distance de buffer utilisé
my_crs <- 29702
buffer_dist <- 10000

# Load boundary
contour_mada <- gadm(country = "Madagascar", level = 0, path = "Data") %>%
  st_as_sf() %>%
  st_transform(my_crs)

# Visualisation de la carte avec les contours
tmap_mode("view")

contour_mada %>%
  st_transform(my_crs) %>%
  tm_shape() +
  tm_borders(col = "black")
  
# Load DHS data 
dhs_folder <- "C:/Users/irian/Documents/Statistiques/PA-livelihood-impact-dhs2/Data/DHS_data"

load_data <- function(year, type, dhs_folder) {
  year_folder <- file.path(dhs_folder, paste0("DHS_", year))
  
  # Get the .shp (GPS) and .dta (household) file paths
  if (type == "HR") {
    hr_path <- list.files(year_folder, pattern = ".*HR.*\\.dta$", full.names = TRUE, recursive = TRUE, ignore.case = TRUE)
    if (length(hr_path) == 0) stop("No HR file found for the specified year.")
    out <- read_dta(hr_path) # Lecture du fichier .dta
  } else if (type == "GPS") {
    shp_path <- list.files(year_folder, pattern = "\\.shp$", full.names = TRUE, recursive = TRUE)
    if (length(shp_path) == 0) stop("No GPS file found for the specified year.")
    out <- st_read(shp_path, quiet = TRUE) %>%
      st_transform(my_crs) # Lecture du fichier .shp
  } else {
    stop("Data type unknown, must be HR or GPS")
  }
  return(out) 
}

# Execute the function for a specific year
hr_1997 <- load_data(1997, "HR", dhs_folder)
gps_1997 <- load_data(1997, "GPS", dhs_folder)

hr_2008 <- load_data(2008, "HR", dhs_folder)
gps_2008 <- load_data(2008, "GPS", dhs_folder)

hr_2021 <- load_data(2021, "HR", dhs_folder)
gps_2021 <- load_data(2021, "GPS", dhs_folder)

# Vérification des données GPS
print(gps_1997) 
print(gps_2008)
print(gps_2021)

st_geometry(gps_1997)
st_geometry(gps_2008)
st_geometry(gps_2021)

# Vérification des données GPS
if (!"DHSCLUST" %in% colnames(gps_1997)) {
  stop("La colonne 'DHSCLUST' n'existe pas dans les données GPS.")
} else {
  message("Les clusters sont bien identifiés.")
}

if (!"DHSCLUST" %in% colnames(gps_2008)) {
  stop("La colonne 'DHSCLUST' n'existe pas dans les données GPS.")
} else {
  message("Les clusters sont bien identifiés.")
}

if (!"DHSCLUST" %in% colnames(gps_2021)) {
  stop("La colonne 'DHSCLUST' n'existe pas dans les données GPS.")
} else {
  message("Les clusters sont bien identifiés.")
}

# Générer et afficher les cartes pour chaque année
dhs_map <- function(gps_data, year) {
  tmap_mode("view")
  
  tm_shape(contour_mada) +
    tm_borders(col = "black") +
    tm_shape(gps_data) +
    tm_symbols(
      col = "URBAN_RURA", 
      palette = c("blue", "green"), 
      title.col = "Zone",
      size = 0.5,
      shape = 21,
      border.col = "black"
    ) +
    tm_layout(title = paste("DHS Clusters -", year))
}

# Création des cartes
dhs_map(gps_1997, 1997)
dhs_map(gps_2008, 2008)
dhs_map(gps_2021, 2021)
```

### Chargement des données et extraction des données de mapme.biodiversity

-   Couvert forestier en 2000 (Hansen et al.2013)

-   Pente et altitude (NASA SRTM)

-   Densité de population en 2000 (Worldpop)

-   Accessibilité en 2000 (JRC, Uchida et Nelson 2011)

-   Précipitations

Nous allons maintenant charger les données géophysiques des ménages à partir de mapme.biodiversity

```{r mapme_2008}

library(mapme.biodiversity)
library(tidyverse)
library(progressr) # Pour avoir des barres de progression
library(tictoc)
library(future)
library(sf)
library(rstac)

# Activer la barre de progression
handlers(global = TRUE)
handlers("progress")


# Vérifier et charger les données
if (file.exists("Data/household_cluster_2008_05.rds")) {
  household_cluster_2008_05 <- readRDS("Data/household_cluster_2008_05.rds")
} else {
 plan(sequential)
      
# Forest cover rate in 2000
tic()
with_progress({
  household_cluster_2008_01 <- household_cluster_2008 %>%
    get_resources(get_gfw_treecover())
})
toc()   

# Slope and elevation
tic()
with_progress({
  household_cluster_2008_02 <- household_cluster_2008 %>%
    get_resources(get_nasa_srtm())
})
toc()

# Population density
tic()
with_progress({
  household_cluster_2008_03 <- household_cluster_2008 %>%
    get_resources(get_worldpop(years = 2000))
})
toc()

# Accessibility
tic()
with_progress({
  household_cluster_2008_04 <- household_cluster_2008 %>%
    get_resources(get_accessibility_2000())
})
toc()

# Precipitation
tic()
with_progress({
  household_cluster_2008_05 <- household_cluster_2008 %>%
    get_resources(
      get_worldclim_max_temperature(),
      get_worldclim_min_temperature(),
      get_worldclim_precipitation()
      )
})
toc() 

# Enregistrement des ressources
cat("Enregistrement des données dans Data/household_cluster_2008_05.rds\n")
  write_rds(x = household_cluster_2008_05, file = "Data/household_cluster_2008_05.rds")

cat("Processus terminé avec succès !\n")
```

## Données sur les aires protégées

Utilisation des données de SGAP (SAPM)

# Treatment and Control groups assignment

-   [Groupe de traitement]{.underline}: ménage vivant dans ou à moins de 10 km des aires protégées entre 2008 et 2021

-   [Groupe de contrôle]{.underline}: ménage vivant à plus de 10 km des aires protégées entre 2008 et 2021

## Création du Buffer zone

-   Création d'un buffer de 10 km autour des aires protégées (dist = 1000)

## Sélection des ménages étudiées

-   Ménages proches des aires protégées créées à partir de 2008

-   Ménages ruraux

# Estimation des effets par Matching

## Matching et optimisation de l'équilibre des groupes

1.  Utilisation du Genetic matching et du Mahalanobis Distance Matching avec la fonction de GenMatch() du package R MatchIt

2.  Application du caliper à un intervalle de 0.25 écart-type de la distance de Mahalanobis

## Vérification de l'équilibre des covariables :

1.  Avant matching pour déterminer les déséquilibres initiaux à partir du test de Standardized Mean Difference (SMD)

    -   Si SMD \< 0.1, il existe un équilibre satisfaisant entre les groupes pour la covariable

    -   Si SMD \> 0.1, le déséquilibre est significatif donc on augmentera l'intervalle des calipers afin d'obtenir un SMD **≤** 0.1)

2.  Après matching: Test visuel sur la qualité du matching

    Comparaison à partir du Q-Q Plot pour chaque covariable (dans le cas où le QQ plot se situe en diagonale, le quantile des 2 distributions sont similaires)

# Estimation par la Difference-in-difference

## Définition des périodes de traitement

-   Période de pré-traitement: Aires protégées crées entre 1997 et 2008

-   Période de post-traitement: Aires protégées crées entre 2008 et 2021 (71 AP créées sur 47 282 km²)

## Vérification de l'hypothèse des tendances parallèles

1.  Création d'un groupe de traitement placebo basé sur les ménages de 1997 (traitement= ménages situés à **≤** 10 km des aires protégées créées entre 2008 et 2021)

2.  Appariement du groupe de traitement placebo avec un groupe de contrôle placebo

3.  Représentation graphique de l'évolution des groupes en 1997, 2008 et 2021 pour une confirmation visuelle

4.  Effectuer un test placebo en faisant une estimation en double différence sur la période de pré-traitement (1997-2008): un effet non significatif confirmerait l'absence de tendances divergentes avant l'intervention

## Estimation du modèle DID

Estimation du modèle DID en utilisant des erreurs standards robustes aux corrélations intra-grappes pour gérer la dépendance des observations au sein des grappes:

-   calcul des résidus à partir du modèle de régression

-   Utilisation des résidus calculés pour construire une matrice variance-covariance robuste, qui va ajuster la corrélation intra-grappe

# Tests de robustesse

## Test de sensibilité aux tailles de buffer

### Test pour une distance de 5 km

-   Création d'un buffer de 5 km autour des aires protégées
-   Réassignation des traitements
-   Matching
-   Test d'équilibre
-   DID
-   Test de robustesse

### Test pour une distance de 15km

-   Création d'un buffer de 15 km autour des aires protégées Matching DID Test de robustesse
-   Réassignation des traitements
-   Matching
-   Test d'équilibre
-   DID
-   Test de robustesse

## Test pour l'hypothèse multiple

La méthode "False Directory Rate" de Benjamini-Hochberg sera appliqué aux hypothèses H2 et H3 pour corriger le problème des tests multiples.

## Analyse de sensibilité de Rosenbaum

Vérification de la robustesse des résultats issus du matching face à un éventuel biais non observé en testant différentes valeurs de Γ, afin d'évaluer dans quelle mesure la présence d'un biais caché pourraient influencer les conclusions de l'analyse

## Test des effets hétérogènes

Estimation des effets hétérogènes en introduisant des interactions entre le traitement et les différentes variables différenciatrices dans un modèle de double DID pour explorer les effets différenciés des aires protégées sur les ménages en fonction des caractéristiques socio-démographiques et environnementales

Caractéristiques socio-démographiques et environnementales:

-   Sexe et âge du chef de ménage

-   Conditions environnementales (Pluviométrie, sécheresse)

-   Type de gouvernance des aires protégées (strictes (statuts IUCN I-IV) vs multi-usages ( statuts IUCN V-VI))

-   Distance aux aires protégées (5km, 10 km, 15 km)

-   Inégalité intra-communautaire (Z-score standardisée du wealth index)

## Pseudo Panel

-   Construction de cohorte de ménage

-   Estimation d'un modèle à effet fixe pour corriger les biais liées aux variables non observés

-   Pondérer les observations en fonction de la taille des cohortes

# Appendix

## Statistical power

-   Estimation de la puissance statistique pour détecter un effet d'au moins 7.5 centiles dans l'indice de richesse entre les groupes

-   EStimation de la probabilité à un seuil de puissance fixée à 0.8 avec un seuil de signification fixée à 0.05

-   **Mobilisation des données MIS 2011, MIS 2013 et MIS 2016 si la puissance statistique est insuffisante**
