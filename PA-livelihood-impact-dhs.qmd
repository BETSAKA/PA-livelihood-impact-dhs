---
title: "PA-livelihood-impact-dhs"
author: "Iriana Razafimahenina"
format: 
  html:
   out-put-file: index.html
   embed-resources: true
   standalone: true
   code-fold: true
  execute: 
   warning: false
   error: false
editor: visual
editor-options: 
   chunk_out_type: console
Bibliography: references.bib
---

## Environnement

```{r}
library(tidyverse) #Manipulation et visualisation des données
library(haven) #Importation des données
library(writexl) #Exportation des données
library(sf) #Analyse des données spatiales
library(tmap) #Analyse cartographique
library(codebook) #Documentation et mise en forme des données 
library(gt) #Mise en forme des tableaux 
library(survey) #Analyse des données d'enquêtes
library(MatchIt) #Matching
library(ggplot2) #Figure

```

## Data structuring

Nous allons charger les données nécessaires à l'analyse.

## Socioeconomic household data

1.  Récupération de la variable hv270a (wealth index de la zone rurale) pour l'année 2021

Le processus consiste à charger les données DHS 1997, 2008 et 2021. DHS 1997 et DHS 2008 ne comprend que les scores factoriels de l'indice de richesse utilisé dans l'enquête, on va dans un premier temps récupérer le wealth index des ménages ruraux de DHS 2021.

```{r}
#Définition du chemin du dossier principal
main_folder <- "../../IRD_Drive/BETSAKA_MADAGASCAR/Données/Enquêtes ménages/DHS Madagascar/DHS_data/"

#Load DHS data
load_data <- function(year, type){
  year_folder <- paste0(main_folder, "DHS_", year)
  
#Get the .shp (GPS) and .dta (household) file paths
  if (type == "HR") {
    hr_path <- list.files(year_folder, pattern = ".*HR.*\\.dta$", full.names = TRUE, recursive = TRUE, ignore.case = TRUE)
    out <- read_dta(hr_path) #Lecture du fichier .dta
  } else if (type == "GPS") {
    shp_path <- list.files(year_folder, pattern = "\\.shp$", full.names = TRUE, recursive = TRUE)
    out <- st_read(shp_path, quiet = TRUE) %>%
      st_transform(4326) #Lecture du fichier .shp
  } else {
    print("data type unknown, must be HR or GPS")
  }
  return (out) 
}
  
#Execute the function for a specific year
  dhs_1997_hr <- load_data(1997, "HR")
  dhs_1997_gps <- load_data(1997, "GPS")
  
  dhs_2008_hr <- load_data(2008, "HR")
  dhs_2008_gps <- load_data(2008, "GPS")
  
  dhs_2021_hr <- load_data(2021, "HR")
  dhs_2021_gps <- load_data(2021, "GPS")
  
#Recover the variable hv270a (rural wealth index) for 2021
dhs_2021_hr <- load_data(2021, "HR")

hv270a_2021 <- dhs_2021_hr %>% 
  filter(hv025 == 2) %>% #Filtrage des ménages ruraux 
  select(hhid, hv270a) %>%
  rename(wealth_index_rural = hv270a)
```

2.  Reproduire le wealth index hv270 pour 1997, 2008 et 2021 puis s'assurer pour 2021 que hv270a correspond au hv270 uniquement pour le rural

Les données DHS 1997 et 2008 ne comportent pas de désagrégation entre les zones urbaines et rurales. DHS 2008 comprend les indices HV270 et HV271, sans indicateurs spécifiques aux zones rurales. DHS 1997 ne comprend aucune variable de richesse précalculée.

Cette partie visera à produire le wealth index de DHS 2008.

```{r}
#Reproduce the wealth index hv270 for 2008 

#Load necessary libraries
library(labelled)
library(janitor)
library(psych)

#Load DHS Data 
hh_2008 <- read_dta("../../IRD_Drive/BETSAKA_MADAGASCAR/Données/Enquêtes ménages/DHS Madagascar/DHS_data/DHS_2008/MDHR51DT/MDHR51FL.DTA")

#Step 1: Recode relevant variables from the DHS household dataset
hh_2008 <- hh_2008 %>%
  filter(hv015 == 1)

hh_2008_rec <- hh_2008 %>%
  mutate(
     # water source
    h2oires = if_else(hv201 == 11, 1, 0),
    h2oyard = if_else(hv201 == 12, 1, 0),
    h2opub = if_else(hv201 == 13, 1, 0),
    h2owell = if_else(hv201 == 21, 1, 0),
    h2opwell = if_else(hv201 == 31, 1, 0),
    h2ouwell = if_else(hv201 == 32, 1, 0),
    h2spring = if_else(hv201 %in% c(41, 42), 1, 0),
    h2osurf = if_else(hv201 == 43, 1, 0),
    h2ooth = if_else(hv201 > 50 & hv201 < 97, 1, 0),
    # Toilet types
    flushp = if_else((hv205 > 10 & hv205 < 15) & hv225 == 0, 1, 0),
    flushs = if_else((hv205 > 10 & hv205 < 15) & hv225 == 1, 1, 0),
    latvipp = if_else(hv205 == 21 & hv225 == 0, 1, 0),
    latvips = if_else(hv205 == 21 & hv225 == 1, 1, 0),
    latslbp = if_else(hv205 %in% c(22, 23) & hv225 == 0, 1, 0),
    latslbs = if_else(hv205 %in% c(22, 23) & hv225 == 1, 1, 0),
    latopp = if_else(hv205 == 24 & hv225 == 0, 1, 0),
    latops = if_else(hv205 == 24 & hv225 == 1, 1, 0),
    latbush = if_else(hv205 == 31, 1, 0),
    latothp = if_else((hv205 > 40 & hv205 < 44) & hv225 == 0, 1, 0),
    latoths = if_else((hv205 > 40 & hv205 < 44) & hv225 == 1, 1, 0),
    # Amenities
    electric = if_else(hv206 == 1, 1, 0),
    radio = if_else(hv207 == 1, 1, 0),
    tv = if_else(hv208 == 1, 1, 0),
    fridge = if_else(hv209 == 1, 1, 0),
    bicycle = if_else(hv210 == 1, 1, 0),
    motobk = if_else(hv211 == 1, 1, 0),
    car = if_else(hv212 == 1, 1, 0),
    mphone = if_else(hv243a == 1, 1, 0),
    watch = if_else(hv243b == 1, 1, 0),
    bank = if_else(hv247 == 1, 1, 0),
    # floor type variables
    dirtfloo = if_else(hv213 %in% c(11, 12), 1, 0),
    plnkfloo = if_else(hv213 == 21, 1, 0),
    palmfloo = if_else(hv213 == 22, 1, 0),
    matfloo = if_else(hv213 %in% c(23, 96), 1, 0),
    parqfloo = if_else(hv213 == 31, 1, 0),
    vinfloo = if_else(hv213 == 32, 1, 0),
    tilefloo = if_else(hv213 == 33, 1, 0),
    cemtfloo = if_else(hv213 == 34, 1, 0),
    carpfloo = if_else(hv213 == 35, 1, 0),
    # Cooking fuel
    cookelec = if_else(hv226 == 1, 1, 0),
    cooklpg = if_else(hv226 %in% c(2, 3, 4, 5), 1, 0),
    cookcoal = if_else(hv226 %in% c(6, 7), 1, 0),
    cookwood = if_else(hv226 == 8, 1, 0),
    cookstrw = if_else(hv226 %in% c(9, 10, 11), 1, 0),
    cooknone = if_else(hv226 %in% c(95, 96), 1, 0),
    #wall materials
    grnwall = if_else(hv214 == 12, 1, 0),
    dirtwall = if_else(hv214 %in% c(11, 13), 1, 0),
    bamwall = if_else(hv214 %in% c(21, 22), 1, 0),
    rwdwall = if_else(hv214 %in% c(23, 24, 25, 26), 1, 0),
    cmtwall = if_else(hv214 == 31, 1, 0),
    stncwall = if_else(hv214 == 32, 1, 0),
    brckwall = if_else(hv214 == 33, 1, 0),
    blckwall = if_else(hv214 == 34, 1, 0),
    woodwall = if_else(hv214 == 36, 1, 0),
    othwall = if_else(hv214 == 96, 1, 0),
    # roofing materials
    natroof = if_else(hv215 %in% c(11, 12), 1, 0),
    sodroof = if_else(hv215 == 13, 1, 0),
    rudroof = if_else(hv215 %in% c(21, 22, 24), 1, 0),
    plnkroof = if_else(hv215 == 23, 1, 0),
    ironroof = if_else(hv215 %in% c(31, 95, 96), 1, 0),
    woodroof = if_else(hv215 == 32, 1, 0),
    cemtroof = if_else(hv215 %in% c(33, 35, 36), 1, 0),
    tileroof = if_else(hv215 == 34, 1, 0),
    # Handle missing values for hv216 and compute members per sleeping room
    hv216 = if_else(is.na(hv216)|hv216 == 0, hv012, hv216),
    memsleep = hv012 / hv216,
    # pondération
    hhmemwt = hv005 / 1000000 * hv012,
    wt = hv005 / 1000000
  )
#Step 2 : Store variable names for reuse
dich_vars_2008 <- c(
  "h2oires", "h2oyard", "h2opub", "h2owell", "h2opwell", "h2ouwell",
  "h2spring", "h2osurf", "h2ooth", "flushp", "flushs", "latvipp", "latvips",
  "latslbp", "latslbs", "latopp", "latops", "latbush", "latothp", "latoths",
  "electric", "radio", "tv", "fridge", "bicycle", "motobk", "car", "mphone",
  "watch", "bank", "memsleep", "dirtfloo", "plnkfloo", "palmfloo", "matfloo",
  "parqfloo", "vinfloo", "tilefloo", "cemtfloo", "carpfloo", "cookelec",
  "cooklpg", "cookcoal", "cookwood", "cookstrw", "cooknone", "grnwall",
  "dirtwall", "bamwall", "rwdwall", "cmtwall", "stncwall", "brckwall",
  "blckwall", "woodwall", "othwall", "natroof", "sodroof", "rudroof",
  "plnkroof", "ironroof", "woodroof", "cemtroof", "tileroof"
)
animal_husbandry_vars <- c(
  "hv246a", "hv246b", "hv246c", "hv246d", "hv246e", "hv246f", "hv246g", "hv246h"
)

all_factor_vars_2008 <- c(dich_vars_2008 , animal_husbandry_vars)

#Step 3 : Compute a correlation matrix for the selected variables

# Perform PCA
perform_pca <- function(data, vars) {
  cor_matrix <- cor(data %>% select(all_of(vars)), use = "complete.obs")
  principal(cor_matrix, nfactors = 1, rotate = "none", scores = TRUE, covar = FALSE)
}

pca_result <- perform_pca(hh_2008_rec, c(dich_vars_2008, animal_husbandry_vars))

# Extract PCA loadings and compute factor scores
hh_2008_rec <- hh_2008_rec %>%
  mutate(
    factor_score = as.vector(scale(hh_2008_rec %>% select(all_of(dich_vars_2008), all_of(animal_husbandry_vars))) %*% pca_result$loadings[, 1])
  )

#Step 4:  Comparison and Visualization
comparison <- tibble(
  variable = paste0("Var", seq_along(pca_result$loadings[, 1])), # Replace with actual names if needed
  dhs_factor_score = c(0.051, 0.036, 0.044, 0.001, 0.006, -0.023, -0.027, -0.040, -0.004,
                       0.049, 0.024, 0.005, 0.010, 0.012, 0.018, 0.011, 0.033, -0.070,
                       0.004, 0.010, 0.096, 0.053, 0.094, 0.060, 0.035, 0.036, 0.047,
                       0.090, 0.072, 0.067, -0.035, -0.022, 0.009, -0.022, -0.059,
                       0.037, 0.004, 0.032, 0.066, 0.007, 0.016, 0.029, 0.084, -0.088,
                       -0.002, 0.001, -0.035, -0.042, -0.017, 0.006, 0.047, 0.013,
                       0.054, 0.014, 0.009, 0.008, -0.047, -0.043, -0.008, -0.007,
                       0.085, -0.005, 0.009, 0.017, -0.017, -0.004, 0.000, -0.009,
                       -0.009, -0.007, -0.003, 0.005), # SPSS values
  r_pca_loading = pca_result$loadings[, 1]
)

# Plot: DHS Loadings vs PCA Loadings
ggplot(comparison, aes(x = dhs_factor_score, y = r_pca_loading)) +
  geom_point() +
  geom_smooth(method = "lm", color = "blue", se = FALSE, linewidth = 0.2) +
  labs(
    title = "DHS Loadings vs. PCA Loadings",
    x = "DHS Factor Loadings",
    y = "Reproduced PCA Loadings"
  ) +
  theme_minimal()

# Correlation and visualization
corr_2008_loadings <- cor.test(comparison$dhs_factor_score, comparison$r_pca_loading)
corr_2008_loadings

# Plot: hv271 vs Factor Score
ggplot(hh_2008_rec, aes(x = hv271, y = factor_score)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "blue", se = FALSE, linewidth = 0.2) +
  labs(
    title = "hv271 vs Computed Factor Score",
    x = "hv271 (Wealth Index Score)",
    y = "Computed Factor Score"
  ) +
  theme_minimal()

# Perform a correlation test between hv271 and factor_score
corr_2008_obs <- cor.test(hh_2008_rec$hv271, hh_2008_rec$factor_score, use = "complete.obs")
corr_2008_obs
```

Reproduction du wealth index DHS 1997

```{r}
#Reproduce the wealth index hv270 for 1997 

#Load necessary libraries
library(labelled)
library(janitor)
library(psych)

#Load DHS Data 
hh_1997 <- read_dta("../../IRD_Drive/BETSAKA_MADAGASCAR/Données/Enquêtes ménages/DHS Madagascar/DHS_data/DHS_1997/MDHR31DT/MDHR31FL.DTA")


#Step 1: Recode relevant variables from the DHS household dataset
hh_1997_rec <- hh_1997 %>% 
  mutate(
    # Specific to 1997 ---------------------
    # Toilet types (latbush below)
    fown = if_else((hv205 == 10 | hv205 == 11), 1, 0),
    latpit  = if_else((hv205 == 20 | hv205 == 21), 1, 0),
    latvip = if_else(hv205 == 22, 1, 0),
    latother = if_else(hv205 == 96, 1, 0),
    latbush = if_else(hv205 == 31, 1, 0),
    # Phone
    phone = if_else(hv221 == 1, 1, 0),
    # Same as 2008 ------------------------
    # water source
    h2oires = if_else(hv201 == 11, 1, 0), # "If piped drinking water in residence"
    h2oiwell = if_else(hv201 == 22, 1, 0), # "If has a well in residence"
    h2osurf = if_else(hv201 %in% c(31, 32, 33, 34), 1, 0), # "If uses river, canal or surface water for drinking"
    h2ooth = if_else(hv201 > 51, 1, 0), # "Other source of drinking water"
    h2ocessi = if_else(hv201 == 23, 1, 0), # "If gets water from an open well/hole/cesspool in residence"
    h2orain = if_else(hv201 == 41, 1, 0), # "If rain for drinking water"
    h2opub = if_else(hv201 == 13, 1, 0), # "If uses a public faucet (piped)"
    h2ocesso = if_else(hv201 == 26, 1, 0), # "If gets water from open well/hole/cesspool outside residence"
    h2oores = if_else(hv201 == 12, 1, 0), # "If has piped water outside residence"
    h2bores = if_else(hv201 == 21, 1, 0), # "If has borehole with pump in residence"
    h2oboout = if_else(hv201 == 24, 1, 0), # "If has borehole with pump outside of residence"
    h2oowell = if_else(hv201 == 25, 1, 0), # "If has well outside of residence"
    h2otruck = if_else(hv201 == 51, 1, 0),# "If gets water from a tanker truck"
    # Amenities
    electric = if_else(hv206 == 1, 1, 0),
    radio = if_else(hv207 == 1, 1, 0),
    tv = if_else(hv208 == 1, 1, 0),
    fridge = if_else(hv209 == 1, 1, 0),
    bicycle = if_else(hv210 == 1, 1, 0),
    motobk = if_else(hv211 == 1, 1, 0),
    car = if_else(hv212 == 1, 1, 0),
    # floor type variables
    dirtfloo = if_else(hv213 %in% c(11, 12), 1, 0),
    woodfloo = if_else(hv213 == 21, 1, 0),
    palmfloo = if_else(hv213 == 22, 1, 0),
    parqfloo = if_else(hv213 == 31, 1, 0),
    vinfloo = if_else(hv213 == 32, 1, 0),
    tilefloo = if_else(hv213 == 33, 1, 0),
    cemtfloo = if_else(hv213 == 34, 1, 0),
    carpfloo = if_else(hv213 == 35, 1, 0),
    othfloor = if_else(hv213 == 96, 1, 0),
    # Handle missing values for hv216 and compute members per sleeping room
    hv216 = if_else(is.na(hv216)|hv216 == 0, hv012, hv216),
    memsleep = hv012 / hv216,
    # pondération
    hhmemwt = hv005 / 1000000 * hv012,
    wt = hv005 / 1000000
  )
# Compute ownland variable 
ir_1997 <- read_dta("../../IRD_Drive/BETSAKA_MADAGASCAR/Données/Enquêtes ménages/DHS Madagascar/DHS_data/DHS_1997/MDIR31DT/MDIR31FL.DTA")

# Compute ownland variable for households
ownland_by_household <- ir_1997 %>%
  select(v001, v002, own_land_partner = v707, own_land_respondent = v740) %>%
  mutate(
    # Convert to binary (1 if owns land personally or by family, 0 otherwise)
    own_land_partner = if_else(own_land_partner %in% c(1, 2), 1, 0, missing = 0),
    own_land_respondent = if_else(own_land_respondent %in% c(1, 2), 1, 0, missing = 0),
    own_any_land = own_land_partner + own_land_respondent) %>%
  group_by(v001, v002) %>%
  summarise(ownland = sum(own_any_land, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(ownland = ifelse(ownland > 0, 1, 0))

# Add ownland variable to hh_1997 by joining on hv001 and hv002
hh_1997_rec <- hh_1997_rec %>%
  left_join(ownland_by_household, by = c("hv001" = "v001", "hv002" = "v002"))
# Check number of unmatched (we do not have data for all hh)
sum(is.na(hh_1997_rec$ownland))
# 1622

# Replace NA in ownland with 0 (if household doesn't have any matching members)
hh_1997_rec <- hh_1997_rec %>%
  mutate(ownland = if_else(is.na(ownland), 0, ownland))

# Define the equivalent variables for 1997 based on SPSS specification and recoded names
pca_loading_dhs <- tibble::tribble(
       ~code,                                            ~variable, ~dhs_factor,
  "electric",                                    "Has electricity",  0.15080,
     "radio",                                          "Has radio",  0.10360,
        "tv",                                     "Has television",  0.13631,
    "fridge",                                   "Has refrigerator",  0.08574,
   "bicycle",                                        "Has bicycle",  0.04035,
    "motobk",                                     "Has motorcycle",  0.04297,
       "car",                                            "Has car",  0.07643,
     "phone",                                      "Has telephone",  0.06839,
   "ownland",     "If household works own or family's agric. land",  -0.09713,
  "memsleep",                "Number of members per sleeping room",  -0.05370,
   "h2oires",               "If piped drinking water in residence",  0.11394,
  "h2oiwell",                         "If has a well in residence",  0.01202,
   "h2osurf", "If uses river, canal or surface water for drinking",  -0.10437,
    "h2ooth",                     "Other source of drinking water",  -0.00177,
      "fown",                           "If uses own flush toilet",  0.09723,
  "h2ocessi",    "Water from open well/hole/cesspool in residence",  0.00524,
   "latbush",                      "If uses bush,field as latrine",  -0.12692,
  "latother",                           "If other type of latrine",  0.00208,
  "dirtfloo",      "If has dirt, sand, dung as  floor in dwelling",  -0.00042,
  "woodfloo",     "If has wood, plank principal floor in dwelling",  0.03547,
  "cemtfloo",                      "If has cement principal floor",  0.08999,
  "othfloor",                      "If has other type of flooring",  -0.00141,
   "h2orain",                         "If rain for drinking water",  -0.00163,
    "h2opub",                    "If uses a public faucet (piped)",  0.08025,
  "h2ocesso",         "Water from open well/hole/cesspool outside",  -0.02915,
    "latpit",                   "If uses a traditional pit toilet",  0.08954,
    "latvip",                              "If uses a VIP latrine",  0.00948,
  "parqfloo",             "If has parquet or polished wood floors",  0.07280,
  "tilefloo",            "If has tiles for main flooring material",  0.03367,
  "palmfloo",          "If has palm or bamboo for floor materials",  -0.12683,
  "carpfloo",                           "If has carpeted flooring",  0.01799,
   "h2oores",               "If has piped water outside residence",  0.01861,
   "h2bores",             "If has borehole with pump in residence",  0.01642,
  "h2oboout",     "If has borehole with pump outside of residence",  -0.01110,
  "h2oowell",                   "If has well outside of residence",  -0.00205,
  "h2otruck",                  "If gets water from a tanker truck",  -0.00265
  )

all_factor_vars_1997 <- pca_loading_dhs$code

#Step 2: Replace missing values
hh_1997_rec <- hh_1997_rec %>%
  mutate(across(all_of(all_factor_vars_1997),
                ~ if_else(is.na(.), mean(., na.rm = TRUE), .)))

#Step 3 : Compute a correlation matrix for the selected variables

# Perform PCA
pca_result_1997 <- perform_pca(hh_1997_rec, all_factor_vars_1997)


# Add factor scores to the dataset
hh_1997_rec <- hh_1997_rec %>%
  mutate(
    factor_score = as.vector(scale(hh_1997_rec %>% 
                                     select(all_of(all_factor_vars_1997))) %*% 
                               pca_result_1997$loadings[, 1]))

# Create a tibble for DHS scores and R PCA loadings
r_pca_loadings <- tibble(
  code = rownames(pca_result_1997$loadings),
  r_pca_loading = as.vector(pca_result_1997$loadings[, 1])
)

#Step 4:  Comparison and Visualization

# Join the tibbles and calculate differences
comparison <- left_join(pca_loading_dhs, r_pca_loadings, by = "code") %>%
  mutate(difference = r_pca_loading - dhs_factor)

# Plot 1: DHS Loadings vs PCA Loadings
ggplot(comparison, aes(x = dhs_factor, y = r_pca_loading)) +
  geom_point() +
  geom_smooth(method = "lm", color = "blue", se = FALSE, linewidth = 0.2) +
  labs(
    title = "DHS Loadings vs. PCA Loadings (1997)",
    x = "DHS Factor Loadings",
    y = "Reproduced PCA Loadings"
  ) +
  theme_minimal()
# Calculate and print the correlation
correlation <- cor.test(comparison$dhs_factor, comparison$r_pca_loading, use = "complete.obs")
print(correlation)
```

3.  Recalculer le wealth index hv270a pour 1997 et 2008

    Calcul du wealth index hv270a pour 2008

```{r}

# Imputation et conversion des valeurs manquantes et des types
hh_2008_rec_updated <- hh_2008_rec %>%
  # Sélectionner les données urbaines et rurales
  mutate(
    hv270a_urban = ifelse(hv025 == 1, 
                          scale(select(., all_of(c(dich_vars_2008, animal_husbandry_vars)))) %*% perform_pca(., c(dich_vars_2008, animal_husbandry_vars))$loadings[, 1], 
                          NA),
    hv270a_rural = ifelse(hv025 == 2, 
                          scale(select(., all_of(c(dich_vars_2008, animal_husbandry_vars)))) %*% perform_pca(., c(dich_vars_2008, animal_husbandry_vars))$loadings[, 1], 
                          NA)
  ) %>%
  # Imputer les valeurs manquantes
  mutate_at(vars(dich_vars_2008), ~ifelse(is.na(.), mean(., na.rm = TRUE), .)) %>%
  mutate_at(vars(animal_husbandry_vars), ~ifelse(is.na(.), 0, .))

# Vérifiez les résultats
head(hh_2008_rec_updated %>% select(hv001, hv025, hv270a_urban, hv270a_rural))


```

3.  Segmentation de wealth index en centiles

4.  Calcul du Z score standardisé du wealth index

5.  Ajout des variables âges et sexes du chef de ménage dans l'analyse
