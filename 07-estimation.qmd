---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Estimation

## Objectif

Le document présente l'estimation en double différence des groupes de traitement et de contrôle pour la période 1997- 2021. Le principe est de comparer l'indice de richesse des ménages de contrôle et de traitement à une période antérieure et une période postérieure à la mise en place des aires protégées.

## Methods

1.  Définition des périodes de traitement

    -   Période de pré-traitement: Aires protégées crées entre 1997 et 2008

    -   Période de post-traitement: Aires protégées crées entre 2008 et 2021 (71 AP créées sur 47 282 km²)

2.  Vérification de l'hypothèse des tendances parallèles

    -   Création d'un groupe de traitement placebo basé sur les ménages de 1997 (traitement= ménages situés à **≤** 10 km des aires protégées créées entre 2008 et 2021)

    -   Appariement du groupe de traitement placebo avec un groupe de contrôle placebo

    -   Représentation graphique de l'évolution des groupes en 1997, 2008 et 2021 pour une confirmation visuelle

    -   Effectuer un test placebo en faisant une estimation en double différence sur la période de pré-traitement (1997-2008): un effet non significatif confirmerait l'absence de tendances divergentes avant l'intervention

3.  Estimation du modèle DID

    -   Estimation du modèle DID en utilisant des erreurs standards robustes aux corrélations intra-grappes pour gérer la dépendance des observations au sein des grappes:

        -   calcul des résidus à partir du modèle de régression

        -   Utilisation des résidus calculés pour construire une matrice variance-covariance robuste, qui va ajuster la corrélation intra-grappe

## Definition of treatment periods

La période de pré-traitement sera les aires protégées créées entre 1997 et 2008. Le post-traitement sera les aires protégées créées entre 2008 et 2021.

-   Période de pré-traitement: Aires protégées crées entre 1997 et 2008 (X AP créées sur Y)

-   Période de post-traitement: Aires protégées crées entre 2008 et 2021 (71 AP créées sur 47 282 km²)

```{r}

# Library
library(did)
library(tidyverse) #Manipulation et visualisation des données
library(tmap) #Analyse cartographique 
library(ggplot2) #Figure
library(sf)
library(gt) #Mise en forme des tableaux 
library(MatchIt)
library(haven)

# Load data 
data_matched_1997 <- read_rds("data/derived/data_matched_1997.rds")
data_matched_2008 <- read_rds("data/derived/data_matched_2008.rds")
data_matched_2021 <- read_rds("data/derived/data_matched_2021.rds")

# Add year in each dataset
data_matched_1997 <- data_matched_1997 %>%
  mutate(year = 1997)
data_matched_2008 <- data_matched_2008 %>%
  mutate(year = 2008)
data_matched_2021 <- data_matched_2021 %>%
  mutate(year = 2021)

# Uniformisation de la colonne hv220 dans chaque dataframe
data_matched_1997$hv220 <- as.numeric(as_factor(data_matched_1997$hv220))
data_matched_2008$hv220 <- as.numeric(as_factor(data_matched_2008$hv220))
data_matched_2021$hv220 <- as.numeric(as_factor(data_matched_2021$hv220))

# Merge the three waves
data_all <- bind_rows(data_matched_1997, data_matched_2008, data_matched_2021)

# Treatment period---------------
data_all <- data_all %>%
  mutate(
    period_DID = case_when(
      DHSYEAR == 1997 ~ 0,           # 1997-2008 = Pre-treatment
      DHSYEAR %in% c(2008,2021) ~ 1  # 2008-2021 = post-treatment
    )
  )

pre_treatment <- data_all %>% filter(period_DID == 0)
post_treatment <- data_all %>% filter(period_DID == 1)
```

## Testing the parallel trends hypothesis 

La méthode de double différence repose sur les hypothèses de tendances parallèles.

1.  Création d'un groupe de traitement placebo basé sur les ménages de 1997 (traitement= ménages situés à **≤** 10 km des aires protégées créées entre 2008 et 2021)

2.  Appariement du groupe de traitement placebo avec un groupe de contrôle placebo

3.  Représentation graphique de l'évolution des groupes en 1997, 2008 et 2021 pour une confirmation visuelle

4.  Effectuer un test placebo en faisant une estimation en double différence sur la période de pré-traitement (1997-2008): un effet non significatif confirmerait l'absence de tendances divergentes avant l'intervention

```{r}
# Placebo Group for 1997--------
# Placebo treatment group = ménages à ≤ 10 km des AP créées entre 2008 et 2021
# Placebo control group = ménages à plus de 10 km des AP créées entre 2008 et 2021
placebo_1997 <- data_all %>%
  filter(DHSYEAR = 1997, URBAN_RURA == 1, distance_to_AP_2008_2021 <= 10) %>%
  mutate(placebo_treated = 1)

placebo_controls_1997
```
