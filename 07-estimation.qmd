---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Estimation

## Objectif

Le document présente l'estimation en double différence des groupes de traitement et de contrôle pour la période 2008 à 2021. Le principe est de comparer l'indice de richesse des ménages de contrôle et de traitement à une période antérieure et à une période postérieure à la mise en place des aires protégées.

## Methods // à améliorer

L' analyse débute par une phase de préparation, comprenant l'importation des données et la définition des périodes d'observation.

## Data preparation

La période de pré-traitement sera la période de 1997 à 2008, et la période de post-traitement sera la période 2008 et 2021. Le groupe de traitement sont les ménages vivant à moins de 10km des aires protégées créées entre 2008 et 2021. Le groupe de contrôle sont les ménages vivant à plus de 10km des aires protégées créées jusqu'en 2021. Les ménages vivant à moins de 10km d'une aire protégée créée avant 2008 seront exclus de l'analyse.

```{r}
# Treatment periods definition--------------------------------
# Pre-Treatment = 1997-2008
# Post-treatment = 2008-2021 


# Library
library(did)
library(tidyverse) 
library(tmap)  
library(ggplot2) 
library(sf)
library(gt) 
library(haven)
library(stargazer)
library(broom)
library(sandwich)
library(lmtest)
library(fixest)


# Load data 
d97 <- read_rds("data/derived/data_matched_1997.rds") %>%
  rename(spei_wc_n_2 = spei_wc_1995,
         spei_wc_n_1 = spei_wc_1996,
         spei_wc_n = spei_wc_1997) %>%
  mutate(hv220 = zap_labels(hv220))

d08 <- read_rds("data/derived/data_matched_2008.rds") %>%
 rename(spei_wc_n_2 = spei_wc_2006,
         spei_wc_n_1 = spei_wc_2007,
         spei_wc_n = spei_wc_2008) %>%
  mutate(hv220 = zap_labels(hv220))

d21 <- read_rds("data/derived/data_matched_2021.rds") %>%
rename(spei_wc_n_2 = spei_wc_2019,
         spei_wc_n_1 = spei_wc_2020,
         spei_wc_n = spei_wc_2021) %>%
  mutate(hv220 = zap_labels(hv220))

# Merge the three waves
data_all <- bind_rows(d97, d08, d21) %>%
  # keep only Treatment/Control
  filter(GROUP %in% c("Treatment", "Control")) %>%
  # treatment indicator
  mutate(treat = as.integer(GROUP == "Treatment"),
         weights = hv005 / 1e6 * weights) %>%
  drop_na()


# Treatment period---------------
dat <- data_all %>%
  mutate(
    period_DID = case_when(
      DHSYEAR == 1997 ~ -1, 
      DHSYEAR == 2008 ~ 0,
      DHSYEAR == 2021 ~ 1 
    )
  )

pre_treatment <- dat %>% filter(period_DID <= 0)
post_treatment <- dat %>% filter(period_DID >= 0)
```

Nous obtenons 6 767 observations pour le pre_treatment et 11 500 observations pour la période de post_treatment.

## Primary outcome: Wealth index

### DID model estimation

L'estimation d'impact repose sur une approche de difference-in-difference, qui consiste à comparer l'évolution du niveau de vie du groupe de traitement et du groupe de contrôle entre 2008 et 2021. Cette approche repose sur l'hypothèse de tendances parallèles, que nous testons à travers un test placebo. Le test placebo consiste à comparer l'évolution du niveau de vie du même groupe de traitement et du même groupe de contrôle entre 1997 et 2008. Si les conditions de vie évoluent parallèlement dans ces deux groupes, alors on considèrera le test placebo comme concluant. Si une différence significative apparaît, on considèrera que la création des aires protégées a eu un impact sur les conditions de vie des riverains, sous réserve que le test placebo soit concluant.

```{r}

library(scales) 

# Préparation des données 
dat_mod <- dat %>% 
  mutate( id = paste0(DHSYEAR, hv005),
          id = as.numeric(id),
          group_recode = case_when(GROUP == "Treatment" ~ 2021,
                                   GROUP == "Control" ~ 0,
                                   GROUP == "Excluded" ~ 1997))

# Vérification  
table(dat_mod$DHSYEAR)


# DID placebo----------------------------------------
# Estimation avec package did
did_callaway_wi <- att_gt(
  yname = "wealth_centile_rural_simple", 
  tname = "DHSYEAR",
  idname = "id",
  gname = "group_recode",
  xformla = ~ spei_wc_n_2 +  spei_wc_n_1 + spei_wc_n + hv219 + hv220,
  control_group = "nevertreated",
  weightsname = "weights",
  data = dat_mod,
  panel = FALSE,
  bstrap = TRUE,
  clustervars = "hv001"
)

summary(did_callaway_wi)
ggdid(did_callaway_wi)

```

Nous avons estimé l'effet moyen du traitement (ATT) pour les clusters ruraux situés à proximité des aires protégées en utilisant la méthode de Doubly Robust Difference-in-difference estimators de Callaway et Sant'Anna @santanna2020.

Les résultats indiquent que, avant le traitement (en 2008), les clusters qui se trouvent près des aires protégées créées en 2021, auraient en moyenne un score de richesse supérieur à celui des clusters éloignés (ATT = 3.02). Après le traitement (2021), le score de richesse des clusters traités reste en moyenne plus élevé que celui du groupe de contrôle (ATT = 4.60). Cependant, pour les deux périodes de traitement, l'intervalle de confiance est large, incluant zéro. Cela indique que l'effet observé n'est pas statistiquement significatif. Ainsi, bien que la tendance suggère un effet positif des aires protégées sur le niveau de richesse des ménages ruraux, les données ne permettent pas de conclure à un impact causal robuste. Néanmoins, l'hypothèse de tendance parallèle est respectée avec un P-value supérieur à 0.05 (0.36634 \> 0.05).

### Intra-cluster standard errors estimation

Nous procédons maintenant à l'estimation du modèle DID en utilisant des erreurs standards robustes aux corrélations intra-grappes. Cette estimation permet de gérer la dépendance des observations au sein des grappes. Le but est d'ajuster les erreurs standards en tenant compte des corrélations intra-grappes présentes au sein des groupes par l'échantillonnage de la variable de résultat @abadie2021. Cet ajustement se calcule sur la base des résidus du modèle et d'une estimation de variance intra-cluster. On calcule les résidus à partir du modèle de régression puis on utilise ces résidus pour construire une matrice variance-covariance robuste. La matrice va ajuster la corrélation intra-grappe en tenant compte la structure corporelle des erreurs.

```{r}

library(stargazer)
library(dplyr)

#-------------------------------------------------
#Erreurs standards robustes intra-cluster (hv001)
#-------------------------------------------------

# Estimation DID placebo avec package fixest 
pre <- dat %>% 
  filter(DHSYEAR %in% c(1997, 2008)) %>%
  mutate(post = as.integer(DHSYEAR == 2008),
         treat_post  = treat * post)

f_pre <- wealth_centile_rural_simple ~ treat + post + treat_post +
  spei_wc_n_2 + spei_wc_n_1 + spei_wc_n + hv219 + hv220

m_pre <- feols(f_pre, data = pre, weights = ~ weights, cluster = ~ hv001)

# DID traitement
main <- dat %>% 
  filter(DHSYEAR %in% c(2008, 2021)) %>%
  mutate(post = as.integer(DHSYEAR == 2021),
         treat_post = treat * post)

f_main <- wealth_centile_rural_simple ~ treat + post + treat_post +
  spei_wc_n_2 + spei_wc_n_1 + spei_wc_n + hv219 + hv220

m_main <- feols(f_main, data = main, weights = ~ weights, cluster = ~ hv001)

etable(m_pre, m_main, vcov = list(~ hv001))

# extract DID row from a fixest summary
did_row <- function(model, year_post, vc = ~ hv001, term = "treat_post") {
  summary(model, vcov = vc) %>%
    broom::tidy() %>%
    filter(term == !!term) %>%
    transmute(year = year_post,
              estimate = estimate,
              se = std.error)
}

did_df <- bind_rows(did_row(m_pre,  year_post = 2008),
                    did_row(m_main, year_post = 2021)) %>%
  mutate(period = factor(ifelse(year == 2008, "1997–2008", "2008–2021"),
                         levels = c("1997–2008", "2008–2021")),
         lo = estimate - 1.96 * se,
         hi = estimate + 1.96 * se)

# plot
ggplot(did_df, aes(x = year, y = estimate, group = 1)) +
  geom_hline(yintercept = 0, linewidth = 0.6, linetype = "dashed") +
  geom_errorbar(aes(ymin = lo, ymax = hi), width = 0.4, linewidth = 0.7) +
  geom_point(size = 3) +
 # geom_line(linewidth = 0.7, alpha = 0.8) +
  scale_x_continuous(breaks = c(2008, 2021)) +
  labs(
    x = "Year (post period of each contrast)",
    y = "DID coefficient on Wealth index centile",
    title = "DID effect over time with PSU-clustered 95% CIs",
    subtitle = 
      "Points at 2008 (placebo 1997–2008) and 2021 (treatment estimate 2008–2021)"
  ) 
```

### Test pre-trend 

```{r}
library(pretrends)

# Extraire les effets estimés par période 
beta <- did_callaway_wi$att

# Erreurs standard 
se <- did_callaway_wi$se

# Matrice de variance-covariance diagonale
sigma <- diag(se^2)
tVec <- did_callaway_wi$t
referencePeriod <- 2008

# Plot 
plot_PT <- data.frame(
  tVec = tVec,
  beta = beta, 
  se = se
)

ggplot(plot_PT, aes(x = tVec, y = beta)) +
  geom_point(size = 3, color = "blue") +
  geom_line(color = "blue") +
  geom_errorbar(aes(ymin = beta - 1.96*se, ymax = beta + 1.96*se), width = 0.1, color = "gray") + 
  geom_vline(xintercept = referencePeriod, linetype = "dashed", color = "red") +
  theme_minimal() +
  labs(
    x = "Année",
    y = "Effet moyen sur le traitement (ATT)",
    title = "Pré-trends et Post-trends"
  )
```

### Graphique DID

```{r}
# Dataset principal
evolution_placebo <- model_data %>%
  group_by(DHSYEAR, GROUP) %>%
  summarise(
    mean_value = mean(wealth_centile_rural_simple, na.rm = TRUE),
    sd_value = sd(wealth_centile_rural_simple, na.rm = TRUE),
    n = n(),
    se = sd_value / sqrt(n),
    .groups = "drop"
  ) %>%
  mutate(Period = "Main (2008-2021)")


# Dataset placebo
evolution_placebo <- placebo_data %>%
  group_by(DHSYEAR, GROUP) %>%
  summarise(
    mean_value = mean(wealth_centile_rural_simple, na.rm = TRUE),
    sd_value = sd(wealth_centile_rural_simple, na.rm = TRUE),
    n = n(),
    se = sd_value / sqrt(n),
    .groups = "drop"
  ) %>%
  mutate(Period = "Placebo (1997-2008)")


# Combined the two datasets 
evolution_combined <- bind_rows(evolution_main, evolution_placebo) %>%
  mutate(GroupPeriod = paste(GROUP, Period, sep = "_"))

# Plot
ggplot(evolution_combined, 
       aes(x = factor(DHSYEAR), 
           y = mean_value, 
           group = interaction(GROUP, Period), color = GROUP)) +
  geom_point(aes(shape = Period), size = 3.5) +
  geom_line(aes(linetype = Period), size = 1.3) +
  geom_errorbar(aes(ymin = mean_value - 1.96 * se, 
                    ymax = mean_value + 1.96 * se),
                width = 0.2, size = 0.8, alpha = 0.5) +
  geom_text(aes(label = sprintf("%.2f", mean_value)),
             vjust = -1, size = 4, color = "black") +
  scale_color_manual(
    values = c("Treatment" = "#D55E00", "Control" = "#0072B2"),
    name = "Group"
  ) +
  scale_linetype_manual( 
    values = c("Main (2008-2021)" = "solid",
               "Placebo (1997-2008)" = "dashed"),
    name = "Period"
  ) +
  scale_y_continuous(
    trans = pseudo_log_trans(base = 10),
    name = "Mean Wealth Index (wealth_centile_rural_simple)"
  ) +
  labs(
    title = "Weath Index Evolution: Main DID vs Placebo",
    x = "Survey Year"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 18),
    axis.title = element_text(face = "bold"),
    legend.position = "top",
    panel.grid.major = element_line(size = 0.3),
    panel.grid.minor = element_blank()
  )
  
```

## Secondary outcome: Z-score of the Wealth index

### Data preparation

```{r}

# Préparation des données 
data_all_mod <- data_all %>% 
  mutate( id = paste0(DHSYEAR, hv005),
          id = as.numeric(id),
          group_recode = case_when(GROUP == "Treatment" ~ 2021,
                                   GROUP == "Control" ~ 0,
                                   GROUP == "Excluded" ~ 1997))

# Vérification  
table(data_all_mod$DHSYEAR)


# Estimation avec le package did
did_callaway_zs <- att_gt(
  yname = "zscore_wealth", 
  tname = "DHSYEAR",
  idname = "id",
  gname = "group_recode",
  xformla = ~ spei_wc_n_2 +  spei_wc_n_1 + spei_wc_n + hv219 + hv220,
  control_group = "nevertreated",
  weightsname = "weights",
  data = data_all_mod,
  panel = FALSE, 
)

summary(did_callaway_zs)
ggdid(did_callaway_zs)

```

### Intra-cluster standard errors estimation

```{r}
# Fonction DID avec fixest 
```

## Graphique DID

```{r}

# Dataset principal
evolution_main_zscore <- model_data %>%
  group_by(DHSYEAR, GROUP) %>%
  summarise(
    mean_value = mean(zscore_wealth, na.rm = TRUE),
    sd_value = sd(zscore_wealth, na.rm = TRUE),
    n = n(),
    se = sd_value / sqrt(n),
    .groups = "drop"
  ) %>%
  mutate(Period = "Main (2008-2021)")


# Dataset placebo
evolution_placebo_zscore <- placebo_data %>%
  group_by(DHSYEAR, GROUP) %>%
  summarise(
    mean_value = mean(zscore_wealth, na.rm = TRUE),
    sd_value = sd(zscore_wealth, na.rm = TRUE),
    n = n(),
    se = sd_value / sqrt(n),
    .groups = "drop"
  ) %>%
  mutate(Period = "Placebo (1997-2008)")


# Combined the two datasets 
evolution_combined <- bind_rows(evolution_main_zscore, evolution_placebo_zscore) %>%
  mutate(GroupPeriod = paste(GROUP, Period, sep = "_"))

# Plot
ggplot(evolution_combined, 
       aes(x = factor(DHSYEAR), 
           y = mean_value, 
           group = interaction(GROUP, Period), color = GROUP)) +
  geom_point(aes(shape = Period), size = 3.5) +
  geom_line(aes(linetype = Period), size = 1.3) +
  geom_errorbar(aes(ymin = mean_value - 1.96 * se, 
                    ymax = mean_value + 1.96 * se),
                width = 0.2, size = 0.8, alpha = 0.5) +
  geom_text(aes(label = sprintf("%.2f", mean_value)),
             vjust = -1, size = 4, color = "black") +
  scale_color_manual(
    values = c("Treatment" = "#D55E00", "Control" = "#0072B2"),
    name = "Group"
  ) +
  scale_linetype_manual( 
    values = c("Main (2008-2021)" = "solid",
               "Placebo (1997-2008)" = "dashed"),
    name = "Period"
  ) +
  scale_y_continuous(
    trans = pseudo_log_trans(base = 10),
    name = "Mean zscore of Wealth Index (zscore_wealth)"
  ) +
  labs(
    title = "Z-score Evolution: Main DID vs Placebo",
    x = "Survey Year"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 18),
    axis.title = element_text(face = "bold"),
    legend.position = "top",
    panel.grid.major = element_line(size = 0.3),
    panel.grid.minor = element_blank()
  )
```
