---
title: "Classification traitement-contrôle des clusters"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

# Environnement

```{r}
library(tidyverse) #Manipulation et visualisation des données
library(haven) #Importation des données
library(writexl) #Exportation des données
library(sf) #Analyse des données spatiales
library(tmap) #Analyse cartographique
library(codebook) #Documentation et mise en forme des données 
library(gt) #Mise en forme des tableaux 
library(survey) #Analyse des données d'enquêtes
library(MatchIt) #Matching
library(ggplot2) #Figure
library(labelled) # Manipulation des labels
library(readxl) #Lecture des fichiers excels
library(progressr) # Pour avoir des barres de progression
library(tictoc) # Pour minuter le temps d'exécution
library(mapme.biodiversity)
library(future) # Pour permettre du calcul parallèle
library(lubridate) # Gestion des dates
library(terra) # Manipulation des données raster 
library(geodata)
```

# Répertoire

```{r}
# Définir le chemin absolu pour ton répertoire local
outdir <- "Statistiques/PA-livelihood-impact-dhs2/Data"

# Créer le répertoire si il n'existe pas déjà
dir.create(outdir, recursive = TRUE, showWarnings = FALSE)

# Vérifier si le répertoire a bien été créé
if (dir.exists(outdir)) {
  cat("Répertoire créé ou déjà existant : ", outdir)
} else {
  cat("Le répertoire n'a pas pu être créé.")
}
mapme_options(
  outdir = outdir,
  verbose = TRUE
              )
```

# Chargement gps

gardez les numéros de cluters + année enquête + rural urbain

L'unité d'analyse de cette étude est le ménage. Nous allons charger nos clusters de 2008 et 2021 à partir des données de DHS.

```{r}
# Définition du système de coordonnées et de la distance de buffer utilisé

# Coordonnées géographiques (Projection officielle-Laborde) 
my_crs <- 29702 

# Buffer de 10 km
buffer_dist <- 10000 

# Load boundary
contour_mada <- gadm(country = "Madagascar", level = 0, path = "Data") %>%
  st_as_sf() %>%
  st_transform(my_crs)

# Visualisation de la carte avec les contours
tmap_mode("view")

contour_mada %>%
  st_transform(my_crs) %>%
  tm_shape() +
  tm_borders(col = "black")
  
# Load DHS data 
dhs_folder <- "C:/Users/irian/Documents/Statistiques/PA-livelihood-impact-dhs2/Data/DHS_data"

load_data <- function(year, type, dhs_folder) {
  year_folder <- file.path(dhs_folder, paste0("DHS_", year))
  
  # Get the .shp (GPS) and .dta (household) file paths
  if (type == "HR") {
    hr_path <- list.files(year_folder, pattern = ".*HR.*\\.dta$", full.names = TRUE, recursive = TRUE, ignore.case = TRUE)
    if (length(hr_path) == 0) stop("No HR file found for the specified year.")
    out <- read_dta(hr_path) # Lecture du fichier .dta
  } else if (type == "GPS") {
    shp_path <- list.files(year_folder, pattern = "\\.shp$", full.names = TRUE, recursive = TRUE)
    if (length(shp_path) == 0) stop("No GPS file found for the specified year.")
    out <- st_read(shp_path, quiet = TRUE) %>%
      st_transform(my_crs) # Lecture du fichier .shp
  } else {
    stop("Data type unknown, must be HR or GPS")
  }
  return(out) 
}

# Execute the function for a specific year
hr_1997 <- load_data(1997, "HR", dhs_folder)
gps_1997 <- load_data(1997, "GPS", dhs_folder)

hr_2008 <- load_data(2008, "HR", dhs_folder)
gps_2008 <- load_data(2008, "GPS", dhs_folder)

hr_2021 <- load_data(2021, "HR", dhs_folder)
gps_2021 <- load_data(2021, "GPS", dhs_folder)

# Vérification des données GPS
print(gps_1997) 
print(gps_2008)
print(gps_2021)

st_geometry(gps_1997)
st_geometry(gps_2008)
st_geometry(gps_2021)

# Vérification des données GPS
if (!"DHSCLUST" %in% colnames(gps_1997)) {
  stop("La colonne 'DHSCLUST' n'existe pas dans les données GPS.")
} else {
  message("Les clusters sont bien identifiés.")
}

if (!"DHSCLUST" %in% colnames(gps_2008)) {
  stop("La colonne 'DHSCLUST' n'existe pas dans les données GPS.")
} else {
  message("Les clusters sont bien identifiés.")
}

if (!"DHSCLUST" %in% colnames(gps_2021)) {
  stop("La colonne 'DHSCLUST' n'existe pas dans les données GPS.")
} else {
  message("Les clusters sont bien identifiés.")
}

# Générer et afficher les cartes pour chaque année
dhs_map <- function(gps_data, year) {
  
  tm_shape(contour_mada) +
    tm_borders(col = "black") +
    tm_shape(gps_data) +
    tm_symbols(
      fill = "URBAN_RURA", 
      fill.legend = tm_legend("Zones"),
      fill.scale = tm_scale(values = c("R" = "red", "U" = "steelblue")),
      size = 0.5,
      shape = 21
    ) +
    tm_title(paste("DHS Clusters -", year))
}

# Création des cartes
dhs_map(gps_1997, 1997)
dhs_map(gps_2008, 2008)
dhs_map(gps_2021, 2021)
```

# Classification des AP

Les données utilisées sont les données de SGAP (SAPM).

```{r}
# library
library(wdpar)
library(pwr)
library(lme4)
library(units)
library(sf)

# Load SAPM data
sapm <- st_read("Data/Aires protégées/SAPM_2017_corrected/SAPM_2017_corrected.shp", quiet = TRUE) %>%
  st_transform(my_crs) %>%
  st_make_valid() %>%
  mutate(YEAR_CREAT = year(ymd(DATE_CREAT)), .after = DATE_CREAT)

# Intersection des SAPM avec la limite de Madagascar
sapm <- sapm %>% 
  st_intersection(contour_mada)%>%
  st_make_valid()

sapm_tb <- sapm %>%
  st_drop_geometry()

write_xlsx(sapm_tb, "Data/Aires protégées/output/SAPM_2017.xlsx")

sapm %>%
  DT::datatable()

# Visualisation
tmap_mode("view")
tm_shape(contour_mada) +
  tm_borders() +
tm_shape(sapm) +
  tm_polygons(fill =  "green", 
              id = "FULL_NAME",
              popup.vars = c("Superficie (ha)" = "HECTARES")) +
  tm_scalebar(position = c("left", "bottom")) + 
  tmap_options(check_and_fix = TRUE) +
  tm_title("Aires protégées de Madagascar") +
  tm_layout(legend.outside = TRUE)
```

## Identification des aires protégées avant et après 2008

-   [Groupe de traitement]{.underline}: clusters à moins de 10 km des aires protégées créées après 2008 dans les zones rurales

-   [Groupe de contrôle]{.underline}: clusters à plus de 10 km des aires protégées dans les zones rurales

-   [Groupe à exclure]{.underline}: clusters à moins de 10 km des aire protégées créées avant 2008 et dans la zone urbaine

```{r}
# Spécification des aires protégées avant 2008
sapm_before_2008 <- sapm %>%
  filter(year(DATE_CREAT) < 2008)

# Spécification des aires protégées après 2008
sapm_after_2008 <- sapm %>%
  filter(year(DATE_CREAT) >= 2008)

# Créer des buffers de 10 km autour des AP
buffer_10km_before_2008 <- sapm_before_2008 %>%
  st_buffer(dist = buffer_dist) %>%
  st_make_valid() %>%
  st_union() %>%
  st_as_sf() %>%
  st_make_valid()

buffer_10km_after_2008 <- sapm_after_2008  %>%
  st_buffer(dist = buffer_dist) %>% 
  st_make_valid() %>%
  st_union() %>%
  st_as_sf() %>%
  st_make_valid()

# Visualisation des cartes 
tm_shape(sapm_before_2008) +
tm_polygons(fill = "darkgreen", 
            col =  "black", 
            fill_alpha = 0.5) +
tm_shape(buffer_10km_after_2008) +
tm_borders(col = "green", lwd = 2, lty = "dashed", fill.legend = tm_legend_hide()) +
tm_shape(buffer_10km_before_2008) +
tm_borders(col = "darkgreen", lwd = 2, lty = "dashed", fill.legend = tm_legend_hide()) +
tm_shape(sapm_after_2008) +
tm_polygons(fill = "green", 
            col = "black", 
            fill_alpha = 0.5) +
tm_add_legend(type = "polygons", fill = c("green", "darkgreen"), labels = c("avant 2008", "après 2008")) +
  tm_title("Aires protégées du SAPM par période de création") +
  tm_layout(
    legend.outside = TRUE, 
    legend.position = c("left", "top"),
    frame = FALSE,
    legend.title.size = 1.2,
    legend.text.size = 0.8
  ) +
  tm_compass(type = "8star", position = c("right", "top")) +
  tm_scalebar(position = c("right", "bottom"))


# Definition de la fonction
create_summary_table <- function(data, pivot_year) {
  summary_table <- data %>%
    st_drop_geometry() %>%
    mutate(
      Creation_Period = case_when(
        YEAR_CREAT < pivot_year ~ paste("Avant", pivot_year),
        YEAR_CREAT >= pivot_year ~ paste("Après", pivot_year)
      ),
      Type = ifelse(str_detect(TYPE_AP, "TERRESTRE"), "Terrestre", "Non terrestre")
    ) %>%
    group_by(Creation_Period, Type) %>%
    summarise(
      Count = n(),
      Area = sum(HECTARES, na.rm = TRUE) / 100,  # Convert hectares to km²
      .groups = 'drop'
    ) %>%
    pivot_wider(
      names_from = Type,
      values_from = c(Count, Area),
      values_fill = list(Count = 0, Area = 0)
    )

  # Ajout des totaux des lignes et des colonnes 
  summary_table <- summary_table %>%
    mutate(
      Total_Count = Count_Terrestre + `Count_Non terrestre`,
      Total_Area = Area_Terrestre + `Area_Non terrestre`
    )

  # Calcul des totaux de toutes les périodes
  total_row <- summary_table %>%
    summarise(
      Creation_Period = "Total",
      Count_Terrestre = sum(Count_Terrestre, na.rm = TRUE),
      `Count_Non terrestre` = sum(`Count_Non terrestre`, na.rm = TRUE),
      Total_Count = sum(Total_Count, na.rm = TRUE),
      Area_Terrestre = sum(Area_Terrestre, na.rm = TRUE),
      `Area_Non terrestre` = sum(`Area_Non terrestre`, na.rm = TRUE),
      Total_Area = sum(Total_Area, na.rm = TRUE)
    )

  # Ajout de la ligne du total das le tableau récapitulatif
  summary_table <- bind_rows(summary_table, total_row)

  # Formatage du tableau avec gt
  gt_table <- gt(summary_table) %>%
    tab_header(
      title = paste("Aires protégées par période de création (Année pivot = ", pivot_year, ")")
    ) %>%
    cols_label(
      Creation_Period = "Période de Création",
      Count_Terrestre = "Terrestres",
      `Count_Non terrestre` = "Non terrestres",
      Total_Count = "Total",
      Area_Terrestre = "Terrestres",
      `Area_Non terrestre` = "Non terrestres",
      Total_Area = "Total"
    ) %>%
    fmt_number(
      columns = c(Count_Terrestre, `Count_Non terrestre`, Total_Count),
      decimals = 0
    ) %>%
    fmt_number(
      columns = c(Area_Terrestre, `Area_Non terrestre`, Total_Area),
      decimals = 0  # Round areas to whole numbers
    ) %>%
    tab_spanner(
      label = "Nombre d'Aires Protégées",
      columns = c(Count_Terrestre, `Count_Non terrestre`, Total_Count)
    ) %>%
    tab_spanner(
      label = "Superficie (km²)",  # Change label to km²
      columns = c(Area_Terrestre, `Area_Non terrestre`, Total_Area)
    ) %>%
    tab_style(
      style = list(
        cell_text(weight = "bold")
      ),
      locations = cells_body(
        rows = Creation_Period == "Total"
      )
    )

  return(gt_table)
}

# Tableau pour 2008
create_summary_table(sapm, 2008)

# Enregistrement 
summary_table_2008 <- create_summary_table(sapm, 2008)
saveRDS(summary_table_2008, "Data/output/summary_table_2008.rds")

```

## Identification du groupe de traitement et du groupe de contrôle en 2008

```{r}
# Harmoniser les CRS des buffers avec les données GPS
buffer_10km_before_2008 <- st_transform(buffer_10km_before_2008, st_crs(gps_2008))
buffer_10km_after_2008 <- st_transform(buffer_10km_after_2008, st_crs(gps_2008))

gps_2008 <- gps_2008 %>%
  # Identifier le groupe de traitement: ménages proche d'AP créées après 2008
  mutate(
    groupe = case_when(
      st_within(geometry, buffer_10km_before_2008, sparse = FALSE)[, 1] & # proche_AP_pre2008 
        !st_within(geometry, buffer_10km_after_2008, sparse = FALSE)[, 1] & # proche_AP_post2008
        URBAN_RURA == "R" ~ "Traitement", 
      st_within(geometry, buffer_10km_before_2008, sparse = FALSE) [,1] |
      URBAN_RURA == "U" ~ "Exclu",
      TRUE ~ "Controle"
    )
  ) %>%
  # identifier le groupe de controle: ménages à plus de 10 km 
  mutate(
    groupe = case_when(
      st_distance(geometry, st_union(buffer_10km_after_2008)) %>% set_units("km") %>% drop_units() > 10 &
        st_distance(geometry, st_union(buffer_10km_before_2008)) %>% set_units("km") %>% drop_units() > 10 &
        URBAN_RURA == "R" ~ "Controle",
      st_distance(geometry, st_union(buffer_10km_after_2008)) %>% set_units("km") %>% drop_units() <= 10 &
        st_distance(geometry, st_union(buffer_10km_before_2008)) %>% set_units("km") %>% drop_units() > 10 &
        URBAN_RURA == "R" ~ "Traitement",
     st_distance(geometry, st_union(buffer_10km_before_2008)) %>% set_units("km") %>% drop_units() <= 10 | URBAN_RURA == "U" ~ "Exclu",
     TRUE ~ groupe
    )
  ) 
  
# Afficher le tableau combiné
table(gps_2008$groupe, useNA = "always")

# Créer un plot pour visualiser la carte des AP avec les clusters
tm_shape(buffer_10km_after_2008) +
  tm_borders("green", 
             lwd = 2, 
             lty = "dashed", 
             fill.legend = tm_legend_hide()) +  
  tm_shape(buffer_10km_before_2008) +
  tm_borders("darkgreen", 
             lwd = 2, 
             lty = "dashed", 
             fill.legend = tm_legend_hide()) +
  tm_shape(sapm_after_2008) +
  tm_polygons(fill = "green", 
              fill_alpha = 0.5,
              col = "black", 
              fill.legend = tm_legend(title = "après 2008", position = tm_pos_in("right", "top"))) +
  tm_shape(sapm_before_2008) +
  tm_polygons(fill = "darkgreen", 
              fill_alpha = 0.5, 
              col =  "black", 
              fill.legend = tm_legend(title = "avant 2008", position = tm_pos_in("right", "top"))) +
  tm_shape(gps_2008) +
  tm_symbols(
    fill = "groupe", 
    fill.legend = tm_legend(title = "Groupes"),
    fill.scale = tm_scale(values = c("Traitement" = "red", "Controle" = "blue", "Exclu" = "gray")),
     size = 0.5,
    shape = 21
  ) +
  tm_add_legend(type = "polygons", 
                fill = c("green", "darkgreen"), 
                labels = c("après 2008", "avant 2008")) +
  tm_title("Grappes d'enquêtes DHS 2008 par rapport aux AP existantes en 2008") +
  tm_layout(
    legend.outside = TRUE, 
    legend.position = c("left", "top"),
    frame = FALSE
  ) +
  tm_scalebar(position = c("left", "bottom"))
```

## Identification des groupes de traitement et de contrôle de 2021

```{r}
# Harmonisation du CRS des buffers avec les données GPS
gps_2021 <- load_data(2021, "GPS", dhs_folder) %>%
  st_transform(st_crs(sapm)) %>%
  st_make_valid()

# Création des buffers pour 2021
buffer_2021 <- sapm %>%
  st_buffer(buffer_dist) %>%
  st_make_valid() %>%
  st_union() %>%
  st_as_sf() %>%
  st_make_valid()%>%
  st_intersection(contour_mada)

# Identification des clusters 
gps_2021 <- gps_2021 %>%
  mutate(
    groupe = case_when(
    st_within(geometry, buffer_10km_after_2008, sparse = FALSE)[, 1] & URBAN_RURA == "R" ~ "Traitement", #proche_AP_post2008
    URBAN_RURA == "U" ~ "Exclu",
    !st_within(geometry, buffer_10km_after_2008, sparse = FALSE)[, 1] & URBAN_RURA == "R" ~ "Controle"
      )
    )

# Créer un plot pour visualiser la carte des AP avec les clusters
tm_shape(sapm) +
  tm_borders(col = "black",
             lwd = 1.5,
             lty = "dashed", 
             fill.legend = tm_legend_hide()) + 
  tm_shape(buffer_10km_after_2008) +
  tm_polygons(fill = "green", 
              fill_alpha = 0.5,
              fill.legend = tm_legend(title = "après 2008", position = tm_pos_in("right", "top"))) +
  tm_borders("green", 
             lwd = 2, 
             lty = "dashed", 
             fill.legend = tm_legend_hide()) + 
  tm_shape(buffer_10km_before_2008) +
  tm_polygons(fill = "darkgreen", 
              fill_alpha = 0.5, 
              col =  "black", 
              fill.legend = tm_legend(title = "avant 2008", position = tm_pos_in("right", "top"))) +
  tm_borders("darkgreen", 
             lwd = 2, 
             lty = "dashed", 
             fill.legend = tm_legend_hide()) +
  tm_shape(gps_2008) +
  tm_symbols(
    fill = "groupe", 
    fill.legend = tm_legend(title = "Groupes"),
    fill.scale = tm_scale(values = c("Traitement" = "blue", "Controle" = "red", "Exclu" = "gray")),
    size = 0.5,
    shape = 21
  ) +
  tm_add_legend(type = "polygons", 
                fill = c("green", "darkgreen"), 
                labels = c("après 2008", "avant 2008")) +
  tm_title("Grappes d'enquêtes DHS 2021 par rapport aux AP existantes en 2021") +
  tm_layout(
    legend.outside = TRUE, 
    legend.position = c("left", "top"),
    frame = FALSE
  ) +
  tm_scalebar(position = c("left", "bottom"))
```

# Sélection des ménages étudiées

-   Ménages proches des aires protégées créées à partir de 2008

-   Ménages ruraux

## Vérification des zones urbaines et rurales des clusters existants

```{r}

# Ajouter les colonnes "zone_urbaine" et "zone_rurale"
gps_2008 <- gps_2008 %>%
  mutate(
    zone_urbaine = ifelse(URBAN_RURA == "U", 1, 0),
    zone_rurale = ifelse(URBAN_RURA == "R",  1, 0)
  )

gps_2021 <- gps_2021 %>%
  mutate(
    zone_urbaine = ifelse(URBAN_RURA == "U",  1, 0),
    zone_rurale = ifelse(URBAN_RURA == "R", 1, 0)
  )


# Vérifier que les clusters urbains sont bien définis
urban_2008 <- gps_2008 %>%
  filter(URBAN_RURA == "U")
  

urban_2021 <- gps_2021 %>%
  filter(URBAN_RURA == "U") 

# Vérifier que les clusters ruraux sont bien définis
rural_2008 <- gps_2008 %>%
  filter(URBAN_RURA == "R")


rural_2021 <- gps_2021 %>%
  filter(URBAN_RURA == "R") 

# Afficher les résultats 
table(gps_2008$URBAN_RURA, useNA = "always")
table(gps_2021$URBAN_RURA, useNA = "always")

# Fonction pour trouver les gps près des AP 
find_nearby_gps <- function(gps_data, sapm_data, buffer_dist, creation_year, after = TRUE) {
  if (after) {
    selected_pas <- sapm_data %>%
      filter(YEAR_CREAT >= creation_year)
  } else {
    selected_pas <- sapm_data %>%
      filter(YEAR_CREAT < creation_year)
  }
  
  selected_pas <- selected_pas %>%
    st_make_valid()
  
  gps_data <- st_transform(gps_data, st_crs(selected_pas))
  
  buffered_pas <- st_buffer(selected_pas, dist = buffer_dist) %>%
    st_make_valid()
  
  merged_buffer <- st_union(buffered_pas) %>%
    st_make_valid()
  
  nearby_gps <- gps_data %>%
    mutate(nearby_pa = st_within(geometry, merged_buffer, sparse = FALSE)[, 1])
  
  return(nearby_gps)
}

# Identify clusters for treatment and exclusion groups
treatment_clusters_2021 <- find_nearby_gps(gps_2021, sapm, 10000, 2008, after = TRUE)
exclusion_clusters_2021 <- find_nearby_gps(gps_2021, sapm, 10000, 2008, after = FALSE)

treatment_clusters_2008 <- find_nearby_gps(gps_2008, sapm, 10000, 2008, after = TRUE)
exclusion_clusters_2008 <- find_nearby_gps(gps_2008, sapm, 10000, 2008, after = FALSE)


# Fonction pour calculer les clusters les ménages des différentes catégories 
clusters_and_households <- function(gps_data, hr_data, treatment_clusters, exclusion_clusters, year) {
  clusters_treatment <- treatment_clusters %>%
    filter(nearby_pa) %>%
    pull(DHSCLUST)
  
  clusters_exclusion <- exclusion_clusters %>%
    filter(nearby_pa) %>%
    pull(DHSCLUST)
  
  clusters_control <- gps_data %>%
    filter(!DHSCLUST %in% c(clusters_treatment, clusters_exclusion)) %>%
    pull(DHSCLUST)
  
  total_clusters <- nrow(gps_data)
  total_households <- nrow(hr_data)
  
  households_treatment <- hr_data %>%
    filter(hv001 %in% clusters_treatment) %>%
    nrow()
  
  households_exclusion <- hr_data %>%
    filter(hv001 %in% clusters_exclusion) %>%
    nrow()
  
  households_control <- hr_data %>%
    filter(hv001 %in% clusters_control) %>%
    nrow()
  
  tibble(
    année = year,
    `Grappes traitement` = length(clusters_treatment),
    `Ménages traitement` = households_treatment,
    `Grappes exclusion` = length(clusters_exclusion),
    `Ménages exclusion` = households_exclusion,
    `Grappes contrôle` = length(clusters_control),
    `Ménages contrôle` = households_control,
    `Total des grappes` = total_clusters,
    `Total des ménages` = total_households
  )
}

# Calculate results for all observations
results_all <- list(
  clusters_and_households(gps_2021, hr_2021, treatment_clusters_2021, exclusion_clusters_2021, 2021),
  clusters_and_households(gps_2008, hr_2008, treatment_clusters_2008, exclusion_clusters_2008, 2008)
) %>%
  bind_rows()

# Calculate results for rural households only
results_rural <- list(
  clusters_and_households(
    gps_2021 %>% filter(URBAN_RURA == "R"),
    hr_2021 %>% filter(hv025 == 2),
    treatment_clusters_2021 %>% filter(URBAN_RURA == "R"),
    exclusion_clusters_2021 %>% filter(URBAN_RURA == "R"),
    2021
  ),
  clusters_and_households(
    gps_2008 %>% filter(URBAN_RURA == "R"),
    hr_2008 %>% filter(hv025 == 2),
    treatment_clusters_2008 %>% filter(URBAN_RURA == "R"),
    exclusion_clusters_2008 %>% filter(URBAN_RURA == "R"),
    2008
  )
) %>%
  bind_rows()

# Add a column for categorization before selecting the columns
combined_results <- bind_rows(
  results_all %>% mutate(Type = "Toutes observations"),
  results_rural %>% mutate(Type = "Zones rurales")  # Change label to "Zones rurales"
)

# Display the results using gt with improved layout and row groups
gt_table <- gt(combined_results) %>%
  tab_header(
    title = "Nombre de grappes et de ménages d'enquêtes DHS classés selon leur proximité avec des aires protégées"
  ) %>%
  cols_label(
    année = "Année",
    `Grappes traitement` = "Traitement",
    `Grappes exclusion` = "Exclusion",
    `Grappes contrôle` = "Contrôle",
    `Total des grappes` = "Total",
    `Ménages traitement` = "Traitement",
    `Ménages exclusion` = "Exclusion",
    `Ménages contrôle` = "Contrôle",
    `Total des ménages` = "Total"
  ) %>%
  tab_spanner(
    label = "Grappes",
    columns = c(`Grappes traitement`, `Grappes exclusion`, `Grappes contrôle`, `Total des grappes`)
  ) %>%
  tab_spanner(
    label = "Ménages",
    columns = c(`Ménages traitement`, `Ménages exclusion`, `Ménages contrôle`, `Total des ménages`)
  ) %>%
  fmt_number(
    columns = c(`Grappes traitement`, `Grappes exclusion`, `Grappes contrôle`, `Total des grappes`,
                `Ménages traitement`, `Ménages exclusion`, `Ménages contrôle`, `Total des ménages`),
    decimals = 0,
    use_seps = TRUE,
    sep_mark = " ",
    dec_mark = ","
  ) %>%
  fmt_number(
    columns = "année",
    decimals = 0,
    use_seps = FALSE
  ) %>%
  cols_align(
    align = "center",
    columns = everything()
  ) %>%
  cols_width(
    `Total des ménages` ~ px(150)
  ) %>%
  tab_options(
    table.width = pct(100)
  ) %>%
  tab_footnote(
    footnote = md("**Traitement**: Observations situées à moins de 10 km des AP créées à partir de 2008. **Exclusion**: Observations situées à moins de 10 km des AP créées avant 2008. **Contrôle**: Autres observations."),
    locations = cells_title(groups = "title")
  ) %>%
  tab_row_group(
    label = "Toutes observations",
    rows = Type == "Toutes observations"
  ) %>%
  tab_row_group(
    label = "Zones rurales",
    rows = Type == "Zones rurales"  # Ensure consistency with the new label
  ) %>%
  cols_hide(
    columns = "Type"  # Hide the Type column after using it for row grouping
  )

# Display the formatted gt table
gt_table

# Enregistrement du tableau
saveRDS(gt_table, "Data/output/tableau_ap_clusters.rds")

# Enregistrement des fichiers des clusters 
saveRDS(gps_2008, "Data/output/gps_2008.rds")
saveRDS(gps_2021, "Data/output/gps_2021.rds")


```
