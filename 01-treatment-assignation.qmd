---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Treatment assignation

## Objectifs

Nous classons les clusters d'enquêtes DHS (1997, 2008 et 2021) par rapport à leur distance aux aires protégées et à leur localisation en zone rurale ou urbaine. Le résultat attendu est le suivant :

-   [Groupe de traitement]{.underline}: clusters à moins de 10 km des aires protégées créées après 2008 dans les zones rurales

-   [Groupe de contrôle]{.underline}: clusters à plus de 10 km des aires protégées dans les zones rurales

-   [Groupe à exclure]{.underline}: clusters à moins de 10 km des aire protégées créées avant 2008 et dans la zone urbaine

## Chargement des coordonnées GPS des clusters d'enquête

Avant de charger les données GPS de 1997, 2008, 2021, nous définissons les coordonnées GPS appliquées. Les coordonnées GPS, comme la plupart des données ouvertes distribuées sur Internet, sont en WGS 84 (codé EPSG : 4326). Pour calculer des distances, on va utiliser le système de projection officiel de Madagascar, qui est le Laborde (EPSG : 29702). On travaille en 4326 et on transforme uniquement quand on a besoin de calculer des surface ou des distances. Après chargement, on fusionne les trois jeux de données en un seul puis le visualiser sur une carte.

```{r}
#| fig-cap: "Grappes d'enquêtes DHS par rapport aux AP existantes en 2008"

library(tidyverse) #Manipulation et visualisation des données
library(sf) #Analyse des données spatiales
library(tmap) #Analyse cartographique
library(gt) #Mise en forme des tableaux 
library(geodata) # Pour avoir le contour de Madagascar
library(writexl) # Pour faire une sortie sous Excel

# Systèmes de coordonnées de référence 
standard_crs <- 4326
mdg_crs <- 29702 

# On charge les données
gps_1997_initial <- st_read("data/raw/dhs/DHS_1997/MDGE32FL/MDGE32FL.shp")
gps_2008_initial <- st_read("data/raw/dhs/DHS_2008/MDGE53FL/MDGE53FL.shp") 
gps_2021_initial <- st_read("data/raw/dhs/DHS_2021/MDGE81FL/MDGE81FL.shp")

# Set for interactive viewing
tmap_mode("view")

bind_rows(gps_1997_initial, gps_2008_initial, gps_2021_initial) |> 
  tm_shape() + 
  tm_dots() +
  tm_facets("DHSYEAR")

```

Nous obtenons une carte distincte pour chaque année d'enquête. Sur chaque carte figure des points dont chaque point représente un cluster d'enquête, correspondant aux coordonnées GPS fournies par DHS.

## Vérification des données gps des clusters

On vérifie que les coordonnées GPS sont bien dans le pays.

```{r}
# Fonction qui vérifie que les coordonnées ne sont pas nulles
check_coordinates <- function(dhs_gps, country_polygon, negate = FALSE) {
  dhs_gps %>%
    filter(LONGNUM != 0 | LATNUM != 0)
}

gps_1997 <- check_coordinates(gps_1997_initial) 
gps_2008 <- check_coordinates(gps_2008_initial) 
gps_2021 <- check_coordinates(gps_2021_initial) 
```

Les coordonnées GPS de 9 clusters de l'enquête 2008 ont été perdus. Il en manque également un en 1997.

## Chargement des données AP

Les données utilisées sont les données de SGAP (SAPM).

On est en cours de vérification pour les dates de création des AP. Pour l'instant on utilise la version officielle de 2017, sur laquelle on a corrigé des anomalies topologiques.

```{r}
# Load SAPM data
sapm <- st_read("data/raw/sapm/SAPM_2017_corrected.shp") |> # en EPSG 9001
  st_transform(standard_crs) %>%
  st_make_valid() %>%
  mutate(YEAR_CREAT = year(ymd(DATE_CREAT)), .after = DATE_CREAT)
# Visualisation
tmap_mode("view")
tm_shape(sapm) +
  tm_polygons(fill =  "green", 
              id = "FULL_NAME",
              popup.vars = c("Superficie (ha)" = "HECTARES")) +
  tm_scalebar(position = c("left", "bottom")) + 
  tmap_options(check_and_fix = TRUE) +
  tm_title("Aires protégées de Madagascar") +
  tm_layout(legend.outside = TRUE)

```

On peut aussi générer un format tabulaire pour visualiser les données.

```{r}
sapm_tb <- sapm %>%
  st_drop_geometry()

dir.create("derived")

write_xlsx(sapm_tb, "data/derived/SAPM_2017.xlsx")

sapm %>%
  DT::datatable()

```

## Sélection des parties terrestres des AP

On garde maintenant les éléments de SAPM qui sont contenu à l'intérieur des AP de Madagascar

```{r}

# Load boundary
contour_mada <- gadm(country = "Madagascar", level = 0, path = "data") %>%
  st_as_sf() %>%
  st_set_crs(standard_crs)

# Intersection des SAPM avec la limite de Madagascar
sapm_terrestre <- sapm %>% 
  st_intersection(contour_mada)%>%
  st_make_valid() %>%
  st_transform(mdg_crs) %>%
  mutate(`HECTARES_TERR` = st_area(.)) %>%
  st_transform(standard_crs)

tm_shape(contour_mada) +
  tm_borders() +
tm_shape(sapm_terrestre) +
  tm_polygons(fill =  "green", 
              id = "FULL_NAME",
              popup.vars = c("Superficie terrestre (ha)" = "HECTARES_TERR")) +
  tm_scalebar(position = c("left", "bottom")) + 
  tmap_options(check_and_fix = TRUE) +
  tm_title("Aires protégées de Madagascar") +
  tm_layout(legend.outside = TRUE)
```

::: callout-warning
On a un poblème avec les unités pour les surfaces dans la carte.
:::

## Création de buffer pour les AP avant et après 2008

On travaille toujours avec les portions terrestres des AP .

Pour distinguer l'impact des aires protégées selon leur période de création, nous avons spécifié les aires protégées créées avant 2008 et à partir de 2008. On applique ensuite une zone tampon de 10 km autour de chaque groupe d'aires protégées. Chaque groupe a été reprojeté dans le système de projection officiel de Madagascar, qui est le Laborde (EPSG : 29702).

```{r}
# Buffer de 10 km
buffer_dist <- 10000 

# Spécification des aires protégées avant 2008
sapm_before_2008 <- sapm_terrestre %>%
  filter(year(DATE_CREAT) < 2008)

# Spécification des aires protégées après 2008
sapm_from_2008 <- sapm_terrestre %>%
  filter(year(DATE_CREAT) >= 2008)

# Créer des buffers de 10 km autour des AP
buffer_10km_before_2008 <- sapm_before_2008 %>%
  st_transform(mdg_crs) %>%
  st_buffer(dist = buffer_dist) %>%
  st_make_valid() %>%
  st_union() %>%
  st_as_sf() %>%
  st_make_valid() %>%
  st_transform(standard_crs)

buffer_10km_from_2008 <- sapm_from_2008  %>%
  st_transform(mdg_crs) %>%
  st_buffer(dist = buffer_dist) %>% 
  st_make_valid() %>%
  st_union() %>%
  st_as_sf() %>%
  st_make_valid() %>%
  st_transform(standard_crs)

# Visualisation des cartes 
tm_shape(sapm_before_2008) +
tm_polygons(fill = "blue", 
            col =  "black", 
            fill_alpha = 0.5) +
tm_shape(buffer_10km_from_2008) +
tm_borders(col = "darkgreen", lwd = 2, lty = "dashed", fill.legend = tm_legend_hide()) +
tm_shape(buffer_10km_before_2008) +
tm_borders(col = "blue", lwd = 2, lty = "dashed", fill.legend = tm_legend_hide()) +
tm_shape(sapm_from_2008) +
tm_polygons(fill = "darkgreen", 
            col = "black", 
            fill_alpha = 0.5) +
tm_add_legend(type = "polygons", fill = c("blue", "darkgreen"), labels = c("avant 2008", "après 2008")) +
  tm_title("Aires protégées du SAPM par période de création") +
  tm_layout(
    legend.outside = TRUE, 
    legend.position = c("left", "top"),
    frame = FALSE,
    legend.title.size = 1.2,
    legend.text.size = 0.8
  ) +
  tm_compass(type = "8star", position = c("right", "top")) +
  tm_scalebar(position = c("right", "bottom"))
```

```{r}
# Definition de la fonction
pivot_year <- 2008

summary_table <- sapm_terrestre %>%
  st_drop_geometry() %>%
  mutate(
    Creation_Period = case_when(
      YEAR_CREAT < pivot_year ~ paste("Avant", pivot_year),
      YEAR_CREAT >= pivot_year ~ paste("A partir de", pivot_year)
    )) %>%
  group_by(Creation_Period) %>%
  summarise(
    Count = n(),
    Area = sum(HECTARES_TERR, na.rm = TRUE) / 100,  # Convert hectares to km²
    .groups = 'drop'
  )


# Formatage du tableau avec gt
gt_table <- gt(summary_table) %>%
  tab_header(
    title = paste("Aires protégées par période de création (Année pivot = ", pivot_year, ")"),
    subtitle = "Zones terrestres uniquement"
  ) %>%
  cols_label(
    Creation_Period = "Période de Création",
    Count = "Nombre d'AP",
    Area = "Surface"
  ) %>%
  fmt_number(
    columns = c(Count, Area),
    decimals = 0
  )

gt_table
```

## Classification des clusters

```{r}
#| fig-cap: "Grappes d'enquêtes DHS par rapport aux AP existantes en 2008"

classify_clusters <- function(cluster_gps, buffer_before, buffer_from,
                              label_treatment = "Treatment",
                              label_excluded = "Excluded",
                              label_control = "Control") {
  cluster_gps %>%
    # Identifier le groupe de traitement: ménages proche d'AP créées après 2008
    mutate(
      groupe = case_when(
        st_within(geometry, buffer_from, sparse = FALSE)[, 1] & # SI près AP récente
          !st_within(geometry, buffer_before, sparse = FALSE)[, 1] & # ET pas près AP ancienne
          URBAN_RURA == "R" ~ label_treatment, # ET rurale, ALORS traitement
        st_within(geometry, buffer_before, sparse = FALSE) [,1] | # SI près AP ancienne
          URBAN_RURA == "U" ~ label_excluded, # OU urbaine, ALORS exclu
        TRUE ~ label_control # SINON contrôle
      )
    ) 
}

# On classe pour 1997
gps_1997_class <- classify_clusters(cluster_gps = gps_1997,
                                    buffer_before = buffer_10km_before_2008,
                                    buffer_from = buffer_10km_from_2008)

gps_2008_class <- classify_clusters(cluster_gps = gps_2008,
                                    buffer_before = buffer_10km_before_2008,
                                    buffer_from = buffer_10km_from_2008)

gps_2021_class <- classify_clusters(cluster_gps = gps_2021,
                                    buffer_before = buffer_10km_before_2008,
                                    buffer_from = buffer_10km_from_2008)


gps_all_class <- bind_rows(
  gps_1997_class,
  gps_2008_class,
  gps_2021_class
)

# Créer un plot pour visualiser la carte des AP avec les clusters
tm_shape(buffer_10km_from_2008) +
  tm_borders("green", 
             lwd = 2, 
             lty = "dashed", 
             fill.legend = tm_legend_hide()) +  
  tm_shape(buffer_10km_before_2008) +
  tm_borders("darkgreen", 
             lwd = 2, 
             lty = "dashed", 
             fill.legend = tm_legend_hide()) +
  tm_shape(sapm_from_2008) +
  tm_polygons(fill = "green", 
              fill_alpha = 0.5,
              col = "black", 
              fill.legend = tm_legend(title = "après 2008", position = tm_pos_in("right", "top"))) +
  tm_shape(sapm_before_2008) +
  tm_polygons(fill = "darkgreen", 
              fill_alpha = 0.5, 
              col =  "black", 
              fill.legend = tm_legend(title = "avant 2008", position = tm_pos_in("right", "top"))) +
  tm_shape(gps_all_class) +
  tm_symbols(
    fill = "groupe", 
    fill.legend = tm_legend(title = "Groupes"),
    fill.scale = tm_scale(values = c("Treatment" = "red", "Control" = "blue", "Excluded" = "gray")),
     size = 0.5,
    shape = 21
  ) +
  tm_facets("DHSYEAR") +
  tm_add_legend(type = "polygons", 
                fill = c("green", "darkgreen"), 
                labels = c("après 2008", "avant 2008")) +
  tm_layout(
    legend.outside = TRUE, 
    legend.position = c("left", "top"),
    frame = FALSE
  ) +
  tm_scalebar(position = c("left", "bottom"))
```

## Statistiques descriptives

```{r}
stats_class <- gps_all_class %>%
  st_drop_geometry() %>%
  group_by(`Année` = DHSYEAR, `Groupe` = groupe) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "Année", values_from = "n")
```

## Enregistrement

```{r}
all_class <- gps_all_class %>%
  select(DHSYEAR, DHSCLUST, GROUP = groupe)

write_csv(all_class, "data/derived/cluster_treatment_classification.csv")
```
