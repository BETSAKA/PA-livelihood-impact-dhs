---
title: "PA-livelihood-impact-dhs (Step)"
author: "Iriana Razafimahenina"
format: 
  html:
    code-summary: "voir le code" 
    embed-resources: true 
    code-fold: true
  execute: 
    warning: false
    error: false
editor: visual
editor-options: 
  chunk_output_type: console
bibliography: references.bib
---

# Environnement

Chargement des librairies nécessaires

```{r}
library(tidyverse) #Manipulation et visualisation des données
library(haven) #Importation des données 
library(writexl) #exportation de données
library(sf) #Analyse des données spatiales
library(tmap) #Analyse cartographique
library(codebook) #Documentation et mise en forme des données
library(gt) #Mise en forme des tableaux
library(survey) #Analyse des données d'enquêtes 
library(MatchIt) #Matching
library(ggplot2) #Figure 
```

# Data

Chargement des données sur:

1.  Conditions socioéconomiques des ménages (DHS)

2.  Environnement géophysique des ménages (mapme.biodiversity)

3.  données sur les aires protégées: données de SGAP (SAPM)

## Household data

### Set the main folder path

```{r}
main_folder <- "C:/Use/irian/Documents/IRD_Drive/BETSAKA_MADAGASCAR/Données/Enquêtes ménages/DHS Madagascar/DHS_data"
```

###Creating a vector of years

```{r}
years <- c("1997","2008","2021")
```

###Load DHS data

```{r}
load_data <- function(year){
  year_folder <- paste0(main_folder, "DHS_", year)
  
  #get the .shp (GPS) and .dta (household) file paths

  shp_path <- list.files(year_folder, pattern= "\\.shp$", full.names = TRUE, recursive = TRUE)
  hr_path <- list.files (year_folder, pattern = ".*HR.*\\.dta$", full.names = TRUE, recursive = TRUE, ignore.case = TRUE)
  
  #Check that there is only one match per year
  if(length(shp_path) !=1 | length(hr_path) != 1) {
    stop(paste0("Unexpected number of files for the year ", year))
  }
  #Read the data 
  
```
#Calcul des variables 

Construction de la variable de résultat principale: wealth index

    Transformation de wealth index en centiles

    Référence: hv270a, disponible pour DHS 2021. DHS fournit également les codes SPSS pour pouvoir effectuer un calcul pour 1997 et 2008

Construction de la variable de résultat secondaire: Z score du wealth index

Construction des variables d'appariement

    -   Chargement des données raster et extraction de la couverture forestière autour de chaque ménage

    -   Chargement des données et extraction de elevation et slope

    -   Chargement des données et extraction des données de densité de population

    -   Chargement des données et extraction des données d'accessibilité

Construction des variables de contrôle

    -   Vérification des valeurs manquantes

    -   Chargement des données sur les précipitations et calcul de l'indice SPEI

#Calcul initial

## Treatment and Control groups assignment
Définition du Buffer

Création d'un buffer de 10 km autour des aires protégées

dist = 1000


Définition des groupes de traitement et des groupes de contrôle

Groupe de traitement: ménage dans ou au moins à 10 km des aires protégées

Groupe de contrôle: ménage à plus de 10 km des aires protégées

spécifier les données utilisées: ruraux

[Exclusion]{.underline}:

-   Ménages proches des aires protégées avant 2008

-   ménages dans les zones urbaines

Vérification de l'appartenance des clusters et des ménages avec la zone tampon

Comparaison des coordonnées des ménages avec la limite de 10 km pour identifier correctement ceux qui sont à l'intérieur ou à l'extérieur du buffer

## Matching

Calcul de Mahalanobis Distance Matching + Caliper de 0.25 écart-type de la distance de Mahalanobis

Utilisation de la fonction de GenMatch() du package R MatchIt pour effectuer l'appariement

Vérification de l'équilibre des covariables :

    -   Avant matching

        Evaluation du déséquilibre initial
        

    -   Après matching:

        -   Test de Standardized Mean Difference (SMD, cible **≤** 0.1)

        -   Comparaison à partir du Q-Q Plot pour chaque covariable (dans le cas où le QQ plot se situe en diagonale, le quantile des 2 distributions sont similaires)

## Difference-in-difference

1.  Définition des périodes de traitement:

    -   Pré-traitement: Aires protégées crées entre 1997 et 2008

    -   Traitement: Aires protégées crées entre 2008 et 2021

2.  Vérification de l'hypothèse de tendances parallèles

    Visualisation des tendances avant 2008

# Tests de Robustesse

## Variation des tailles de buffer

1.  Comparaison des coefficients: test de \[0-5km\] et \[0-15\]

## FDR

Test des 3 hypothèses à partir de la méthode "False Directory Rate" de Benjamini-Hochberg pour contrôler le risque découvertes dans les hypothèses secondaires

## Analyse de sensibilité de Rosenbaum


## Approche de Pseudo Panel

    -   Construction de cohorte de ménage

    -   estimation d'un modèle à effet fixe pour corriger les biais liées aux variables non observés

    -   Pondérer les observations en fonction de la taille des cohortes

# Appendix

## Statistical power

1.  Détermination de la probabilité à détecter un effet réel (fixée à 80 % avec un seuil de signification de 5%)

2.  Estimation de la puissance statistique pour détecter un effet d'au moins 7.5 centiles dans l'indice de richesse
