---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Descriptive statistics

## Objectif

## Statistiques descriptive des aires protégées

```{r}

library(tidyverse) #Manipulation et visualisation des données
library(writexl) # Pour faire une sortie sous Excel
library(psych)
library(knitr)
library(sf)

# On charge les données
wdpa_before_2008 <- st_read("data/derived/wdpa_before_2008.csv") 

wdpa_from_2008 <- read.csv("data/derived/wdpa_from_2008.csv")

# Fonction utilitaire pour produire les statistiques d'une période
get_descriptive_stats <- function(data, periode_label) {
  data <- data %>%
  mutate(REP_AREA = as.numeric(REP_AREA))
  
  stats <- describe(data$REP_AREA)[, c("n", "mean", "sd", "median", "min", "max")]
  
  min_name <- data %>%
    filter(REP_AREA == min(REP_AREA, na.rm = TRUE)) %>%
    pull(ORIG_NAME) %>%
    unique() %>%
    paste(collapse = "; ")
  
  max_name <- data %>%
    filter(REP_AREA == max(REP_AREA, na.rm = TRUE)) %>%
    pull(ORIG_NAME) %>%
    unique() %>%
    paste(collapse = "; ")
  
  stats %>%
    as_tibble() %>%
    mutate(
      periode = periode_label,
      aire_min = min_name,
      aire_max = max_name
    )
}

# Appliquer la fonction aux deux périodes
desc_AP_before <- get_descriptive_stats(wdpa_before_2008, "Before 2008")
desc_AP_from   <- get_descriptive_stats(wdpa_from_2008, "From 2008")


# Fusion des deux tableaux
desc_AP_combined <- rbind(desc_AP_before, desc_AP_from %>%
  select(periode, n, mean, sd, median, min, aire_min, max, aire_max))


# Affichage du tableau 
kable(desc_AP_combined, digits = 2, caption = "Statistiques descriptives des aires protégées (REP_AREA)")

# Enregistrement du tableau
write_csv(desc_AP_combined, "data/derived/tableau_descriptive.csv")

# Fonction pour produire les 10 plus petites aires protégées
get_top_small_aires <- function(df_input, periode_label, top_n = 10) {
  df_input %>%
    mutate(REP_AREA = as.numeric(REP_AREA)) %>%
    arrange(REP_AREA) %>%
    slice_head(n = top_n) %>%
    mutate(
      rank_number = row_number(),
      periode = periode_label
    ) %>% 
    select(rank_number, ORIG_NAME, REP_AREA) 
}

# Appliquer aux deux périodes
top10_before_2008 <- get_top_small_aires(wdpa_before_2008, "Before 2008")
top10_from_2008  <- get_top_small_aires(wdpa_from_2008, "From 2008")

# Fusionner les tableaux
top10_combined <- bind_rows(top10_before_2008, top10_from_2008)

# Affichage
kable(top10_combined, digits = 2,
      caption = "Statistiques descriptives des aires protégées (REP_AREA) avec top 10 plus petites")

# Enregistrement du tableau
write_csv(desc_AP_combined, "data/derived/tableau_descriptive.csv")
```

## Statistiques descriptives du wealth index et du z-score du wealth index

### Année 1997

```{r}
# On charge les données
hh_1997_rural <- readRDS("data/derived/hh_1997_rural_simpler.rds")

# Sélection des colonnes d'intérêt
vars <- c("wealth_centile_rural_simple", "zscore_wealth")

# Créer le tableau descriptif
desc_1997 <- hh_1997_rural %>%
  summarise(
    n_centile = sum(!is.na(wealth_centile_rural_simple)),
    mean_centile = mean(wealth_centile_rural_simple, na.rm = TRUE),
    sd_centile = sd(wealth_centile_rural_simple, na.rm = TRUE),
    median_centile = median(wealth_centile_rural_simple, na.rm = TRUE),
    min_centile = min(wealth_centile_rural_simple, na.rm = TRUE),
    max_centile = max(wealth_centile_rural_simple, na.rm = TRUE),
    
    n_zscore = sum(!is.na(zscore_wealth)),
    mean_zscore = mean(zscore_wealth, na.rm = TRUE),
    sd_zscore = sd(zscore_wealth, na.rm = TRUE),
    median_zscore = median(zscore_wealth, na.rm = TRUE),
    min_zscore = min(zscore_wealth, na.rm = TRUE),
    max_zscore = max(zscore_wealth, na.rm = TRUE)
  ) %>%
  # Transformer en format long
  pivot_longer(
    everything(),
    names_to = c("stat", "variable"),
    names_sep = "_"
  ) %>%
  pivot_wider(
    names_from = stat,
    values_from = value
  ) %>%
  # Renommer les variables
  mutate(
    variable = case_when(
      variable == "centile" ~ "Wealth index en Centile",
      variable == "zscore" ~ "Z-score wealth index",
      TRUE ~ variable
    )
  )

# Affichage du tableau
kable(desc_1997, digits = 2, caption = "Statistiques descriptives des variables de richesse rurale (1997)")

# Export vers Excel
write_xlsx(desc_1997, "data/derived/descriptive_wealth_rural_1997.xlsx")

```

### Année 2008

```{r}
# On charge les données
hh_2008_rural <- readRDS("data/derived/hh_2008_rural_simpler.rds")

# Créer le tableau descriptif
desc_2008 <- hh_2008_rural %>%
  summarise(
    n_centile = sum(!is.na(wealth_centile_rural_simple)),
    mean_centile = mean(wealth_centile_rural_simple, na.rm = TRUE),
    sd_centile = sd(wealth_centile_rural_simple, na.rm = TRUE),
    median_centile = median(wealth_centile_rural_simple, na.rm = TRUE),
    min_centile = min(wealth_centile_rural_simple, na.rm = TRUE),
    max_centile = max(wealth_centile_rural_simple, na.rm = TRUE),
    
    n_zscore = sum(!is.na(zscore_wealth)),
    mean_zscore = mean(zscore_wealth, na.rm = TRUE),
    sd_zscore = sd(zscore_wealth, na.rm = TRUE),
    median_zscore = median(zscore_wealth, na.rm = TRUE),
    min_zscore = min(zscore_wealth, na.rm = TRUE),
    max_zscore = max(zscore_wealth, na.rm = TRUE)
  ) %>%
  # Transformer en format long
  pivot_longer(
    everything(),
    names_to = c("stat", "variable"),
    names_sep = "_"
  ) %>%
  pivot_wider(
    names_from = stat,
    values_from = value
  ) %>%
  # Renommer les variables 
  mutate(
    variable = case_when(
      variable == "centile" ~ "Wealth index en Centile",
      variable == "zscore" ~ "Z-score wealth index",
      TRUE ~ variable
    )
  )

# Affichage du tableau
kable(desc_2008, digits = 2, caption = "Statistiques descriptives des variables de richesse rurale (2008)")

# Export vers Excel
write_xlsx(desc_2008, "data/derived/descriptive_wealth_rural_2008.xlsx")

```

### Année 2021

```{r}
# On charge les données
hh_2021_rural <- readRDS("data/derived/hh_2021_rural_simpler.rds")

# Créer le tableau descriptif
desc_2021 <- hh_2021_rural %>%
  summarise(
    n_centile = sum(!is.na(wealth_centile_rural_simple)),
    mean_centile = mean(wealth_centile_rural_simple, na.rm = TRUE),
    sd_centile = sd(wealth_centile_rural_simple, na.rm = TRUE),
    median_centile = median(wealth_centile_rural_simple, na.rm = TRUE),
    min_centile = min(wealth_centile_rural_simple, na.rm = TRUE),
    max_centile = max(wealth_centile_rural_simple, na.rm = TRUE),
    
    n_zscore = sum(!is.na(zscore_wealth)),
    mean_zscore = mean(zscore_wealth, na.rm = TRUE),
    sd_zscore = sd(zscore_wealth, na.rm = TRUE),
    median_zscore = median(zscore_wealth, na.rm = TRUE),
    min_zscore = min(zscore_wealth, na.rm = TRUE),
    max_zscore = max(zscore_wealth, na.rm = TRUE)
  ) %>%
  # Transformer en format long
  pivot_longer(
    everything(),
    names_to = c("stat", "variable"),
    names_sep = "_"
  ) %>%
  pivot_wider(
    names_from = stat,
    values_from = value
  ) %>%
  # Renommer les variables
  mutate(
    variable = case_when(
      variable == "centile" ~ "Wealth index en Centile",
      variable == "zscore" ~ "Z-score wealth index",
      TRUE ~ variable
    )
  )

# Affichage du tableau
kable(desc_2021, digits = 2, caption = "Statistiques descriptives des variables de richesse rurale (2021)")

# Export vers Excel
write_xlsx(desc_2021, "data/derived/descriptive_wealth_rural_2021.xlsx")

```

## Statistiques descriptives des variables utilisées dans le modèle

```{r}
library(tidyverse)
library(sf)
library(haven)

# Load data 
hr_1997_final <- readRDS("data/derived/hr_1997_final.rds")

hr_2008_final <- readRDS("data/derived/hr_2008_final.rds")
  
hr_2021_final <- readRDS("data/derived/hr_2021_final.rds")

# Sélection des colonnes d'intérêt
vars_ut <- c("treecover_area_2000", "slope_2000", "elevation_2000", "population_count_2000", "traveltime_2000_2000", "spei_wc_1995", "spei_wc_1996", "spei_wc_1997", "spei_wc_2006", "spei_wc_2007", "spei_wc_2008","spei_wc_2019", "spei_wc_2020", "spei_wc_2021" )

# Fonction pour statistiques descriptives robustes
calc_descr_stats <- function(df, vars) {
  vars_exist <- intersect(vars, names(df))       # colonnes existantes
  df_num <- df %>% select(all_of(vars_exist)) %>% select(where(is.numeric))
  
  if (ncol(df_num) == 0) return(NULL)           # si aucune colonne numérique
  
  data.frame(
    Variable = names(df_num),
    N        = sapply(df_num, function(x) sum(!is.na(x))),
    Mean     = sapply(df_num, function(x) mean(x, na.rm = TRUE)),
    SD       = sapply(df_num, function(x) sd(x, na.rm = TRUE)),
    Min      = sapply(df_num, function(x) min(x, na.rm = TRUE)),
    Median   = sapply(df_num, function(x) median(x, na.rm = TRUE)),
    Max      = sapply(df_num, function(x) max(x, na.rm = TRUE))
  )
}

# Calculer pour chaque dataframe
descr_1997 <- calc_descr_stats(hr_1997_final, vars_ut) %>% mutate(Year = 1997)
descr_2008 <- calc_descr_stats(hr_2008_final, vars_ut) %>% mutate(Year = 2008)
descr_2021 <- calc_descr_stats(hr_2021_final, vars_ut) %>% mutate(Year = 2021)

# Combiner dans un seul tableau
descr_stats_vars <- bind_rows(descr_1997, descr_2008, descr_2021)

# Affichage
descr_stats_vars 
```

## Statistiques descriptives (partie estimation)

```{r}
#| eval: false

# ATTENTION placebo_data_wi n'existe pas : on n'exécute pas ce bloc

# Statistiques descriptives 
evolution_placebo_wi <- placebo_data_wi %>%
  group_by(DHSYEAR, GROUP) %>%
  summarise(
    mean_value = mean(wealth_centile_rural_simple , na.rm = TRUE),
    sd_value = sd(wealth_centile_rural_simple , na.rm = TRUE),
    n = n(),
    se = sd_value / sqrt(n),
    .groups = "drop"
  )

# Ajout d'un label pour différencier la période pré/ post
evolution_placebo_wi <- evolution_placebo_wi %>%
  mutate(period = ifelse(DHSYEAR < 2008, "Pre-treatment", "Post-treatment"))
```
